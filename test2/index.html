<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- キャッシュ対策 -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">

    <title>TOT Logger (Live Server)</title>
    
    <!-- Fonts & Icons -->
    <link rel="stylesheet" href="https://use.typekit.net/erb7jzd.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />

    <style>
        /* =========================================
           1. VARIABLES & BASE
           ========================================= */
        :root {
            /* Backgrounds */
            --c-bg-body: #000000;
            --c-bg-card: #111111;
            --c-bg-input: #1a1a1a;
            --c-bg-btn: #000000;
            --c-bg-btn-active: #ffffff;
            --c-bg-element: #222222;
            --c-bg-hover: #333333;
            
            /* Text */
            --c-text-main: #e0e0e0;
            --c-text-sub: #888888;
            --c-text-inverse: #000000;
            --c-text-accent: #ffffff;
            --c-text-muted: #666666;
            
            /* Borders */
            --c-border: #333333;
            --c-border-light: #444444;
            
            /* Functional */
            --c-caution: #ff5555;
            --c-caution-bg: #221111;
            
            /* Layout & Spacing */
            --radius-sm: 6px;
            --radius-md: 12px;
            --radius-pill: 24px;
            
            --font-main: 'Noto Sans JP', sans-serif;
            --font-display: "stencil-std", sans-serif;
            
            --space-xs: 8px;
            --space-sm: 16px;
            --space-md: 24px;
            --space-lg: 40px;
            --space-xl: 60px;
        }

        body {
            background-color: var(--c-bg-body); color: var(--c-text-main); font-family: var(--font-main);
            margin: 0; padding: 0; text-align: center; box-sizing: border-box; width: 100%; font-weight: 400;
            line-height: 1.5;
            overscroll-behavior-y: contain; 
            touch-action: pan-y; 
        }
        .main-wrapper { max-width: 600px; margin: 0 auto; padding: 0; box-sizing: border-box; position: relative; min-height: 100vh; display: flex; flex-direction: column; }

        body.modal-open { overflow: hidden; }

        /* =========================================
           Header
           ========================================= */
        header.app-header {
            display: flex; justify-content: space-between; align-items: center;
            padding: 15px; 
            background: var(--c-bg-body);
            position: sticky; top: 0; z-index: 100;
            border-bottom: 1px solid var(--c-border);
        }
        
        .header-left, .header-right { display: flex; align-items: center; width: 40px; }
        .header-right { justify-content: flex-end; }
        
        h1.app-title {
            font-family: var(--font-display); font-size: 1.5rem; margin: 0;
            color: var(--c-text-accent); letter-spacing: 2px;
            flex: 1; text-align: center; 
        }

        .auth-btn {
            background: transparent; border: none; color: var(--c-text-main);
            width: 36px; height: 36px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; padding: 0;
        }
        .auth-user-img { width: 32px; height: 32px; border-radius: 50%; object-fit: cover; border: 1px solid var(--c-border-light); }
        .auth-btn .material-symbols-outlined { font-size: 32px; color: var(--c-text-sub); }

        .refresh-btn {
            background: transparent; border: none; color: var(--c-text-main);
            width: 36px; height: 36px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer;
        }

        /* =========================================
           Tab Navigation
           ========================================= */
        .tab-group { 
            display: flex; 
            border-bottom: 1px solid var(--c-border); 
            background: var(--c-bg-surface); 
            position: sticky; top: 67px; 
            z-index: 90;
        }
        .tab-btn { 
            flex: 1; padding: 12px; 
            background: transparent; border: none; 
            color: var(--c-text-sub); font-weight: bold; 
            cursor: pointer; transition: 0.2s; 
            border-bottom: 3px solid transparent; font-size: 0.9rem; 
        }
        .tab-btn.active { 
            color: var(--c-text-accent); 
            border-bottom-color: var(--c-text-accent); 
            background: var(--c-bg-element); 
        }

        /* =========================================
           Main Content Area
           ========================================= */
        .app-container { flex: 1; display: flex; flex-direction: column; }
        .content-area { 
            flex: 1; 
            padding: 15px 15px 80px 15px; 
            min-height: 50vh; 
        }
        
        .empty-state {
            padding: 40px 20px; text-align: center; color: var(--c-text-muted); font-size: 0.9rem;
        }
        
        .status-message {
            padding: 40px 20px; 
            text-align: center; 
            color: var(--c-text-muted); 
            font-size: 0.9rem;
            width: 100%;
            box-sizing: border-box;
        }

        /* =========================================
           Common Components
           ========================================= */
        .label {
            font-size: 0.85rem; color: var(--c-text-secondary); 
            margin-bottom: 10px; 
            text-align: left; padding: 0; padding-left: 6px; 
            font-weight: bold;
            display: flex; justify-content: space-between; align-items: baseline;
            width: 100%; box-sizing: border-box;
            transition: color 0.3s;
        }
        
        /* モーダル内の見出しパディングリセット */
        .modal-body .label {
            padding-left: 0;
        }

        .label-left { display: flex; align-items: center; }
        .label-right { font-size: 0.7rem; color: var(--c-text-muted); font-weight: normal; letter-spacing: 0.5px; }
        
        .past-log-label {
            font-size: 0.85rem; color: var(--c-text-secondary); 
            text-align: left; 
            font-weight: bold;
            padding-left: 6px; 
            padding-bottom: 0; 
            margin: 14px 0 0 0; 
            border-bottom: none; 
        }
        
        /* リスト先頭の過去ログ見出しのマージン削除 */
        .log-list-container > .past-log-label:first-child,
        .shared-content-inner > .past-log-label:first-child {
            margin-top: 0;
        }

        .btn {
            background-color: var(--c-bg-btn); color: #ccc; border: 1px solid var(--c-border-light);
            border-radius: var(--radius-sm); padding: 14px 0; font-size: 1rem;
            font-weight: 700; cursor: pointer; transition: all 0.15s ease; width: 100%; font-family: var(--font-main);
        }
        .btn:active { transform: scale(0.98); }
        .btn:hover { background-color: #222; color: #fff; border-color: #666; }
        .btn.selected { background-color: var(--c-bg-btn-active); color: var(--c-text-inverse); border-color: var(--c-bg-btn-active); }
        .btn.selected:hover { background-color: #e0e0e0; }
        
        .btn-caution, .btn-suspended-view, .btn-used { border-style: dashed !important; border-color: var(--c-border-light) !important; color: var(--c-text-muted) !important; }
        .btn-caution:hover, .btn-suspended-view:hover, .btn-used:hover { color: var(--c-text-sub) !important; border-color: var(--c-text-sub) !important; }
        .btn-caution.selected, .btn-suspended-view.selected, .btn-used.selected { background-color: #ccc !important; color: #000 !important; border-style: solid !important; border-color: #ccc !important; opacity: 1; }

        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; }
        
        .input-block { margin-bottom: var(--space-md); border-radius: var(--radius-sm); transition: all 0.3s; }
        .error-icon { display: none; color: var(--c-caution); font-size: 1.2rem; margin-left: 8px; vertical-align: middle; }
        .input-missing .error-icon { display: inline-block; }

        /* =========================================
           Input Components (Modal Specific)
           ========================================= */
        .date-counter-area { background: var(--c-bg-card); padding: 20px; border-radius: var(--radius-md); border: 1px solid var(--c-border); margin-bottom: var(--space-md); display: flex; flex-direction: column; gap: 15px; }
        .date-row { text-align: center; }
        .date-row input[type="date"] { width: 100%; max-width: 100%; box-sizing: border-box; background: var(--c-bg-body); color: var(--c-text-accent); border: 1px solid var(--c-border-light); border-radius: var(--radius-sm); font-size: 1.1rem; font-weight: bold; text-align: center; padding: 12px; color-scheme: dark; font-family: var(--font-main); }

        .counter-ui { display: flex; align-items: center; justify-content: center; gap: 20px; }
        .counter-btn { width: 48px; height: 48px; border-radius: 50%; background: var(--c-bg-input); color: var(--c-text-accent); border: 1px solid var(--c-border-light); font-size: 1.4rem; cursor: pointer; transition: 0.2s; display: flex; align-items: center; justify-content: center; }
        .counter-btn:hover { background: var(--c-bg-hover); border-color: var(--c-text-sub); }
        .counter-display { font-size: 2rem; font-weight: 700; min-width: 80px; color: var(--c-text-accent); }
        .unit { font-size: 0.9rem; color: var(--c-text-sub); font-weight: normal; margin-left: 4px; }

        .time-section-fixed { display: flex; justify-content: center; align-items: center; height: 40px; }
        .time-widget { position: relative; background: #0a0a0a; border: 1px solid #444; border-radius: 20px; height: 34px; width: 130px; display: flex; align-items: center; justify-content: center; cursor: pointer; overflow: hidden; transition: all 0.3s cubic-bezier(0.25, 1, 0.5, 1); color: var(--c-text-sub); }
        .time-widget:hover { background: var(--c-bg-element); border-color: var(--c-text-muted); color: var(--c-text-accent); }
        .time-widget.active { width: 160px; background: var(--c-bg-element); border-color: var(--c-text-accent); color: var(--c-text-accent); cursor: default; }
        .time-placeholder { display: flex; align-items: center; gap: 6px; font-size: 0.8rem; font-weight: bold; letter-spacing: 0.5px; white-space: nowrap; position: absolute; transition: opacity 0.2s; }
        .time-widget.active .time-placeholder { opacity: 0; pointer-events: none; }
        .time-editor { display: flex; align-items: center; gap: 5px; opacity: 0; pointer-events: none; transition: opacity 0.3s 0.1s; }
        .time-widget.active .time-editor { opacity: 1; pointer-events: auto; }
        .time-editor input[type="time"] { background: transparent; border: none; color: var(--c-text-accent); font-size: 1rem; font-family: var(--font-main); width: 90px; text-align: center; padding: 0; outline: none; }
        .time-editor input[type="time"]::-webkit-calendar-picker-indicator { display: none; -webkit-appearance: none; }
        .time-clear-btn { background: var(--c-border-light); border: none; color: var(--c-text-secondary); width: 22px; height: 22px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: 0.2s; flex-shrink: 0; }
        .time-clear-btn:hover { background: var(--c-text-muted); color: var(--c-text-accent); }
        .time-clear-btn .material-symbols-outlined { font-size: 12px; }
        
        .status-bar-wrapper { margin-top: 15px; }
        .status-bar { border: 1px solid var(--c-border); background: var(--c-bg-card); padding: 10px; border-radius: var(--radius-sm); font-weight: bold; color: var(--c-text-accent); font-size: 0.95rem; }
        .vehicle-btn { height: 56px; font-size: 1.3rem; display: flex; justify-content: center; align-items: center; }
        .profile-btn { font-size: 0.75rem; padding: 10px 0; line-height: 1.2; word-break: break-all; }
        
        .vehicle-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
        
        /* 任意項目エリア */
        .optional-area {
            border: 1px dashed #222;
            padding: 24px 15px; 
            border-radius: var(--radius-sm);
            margin-bottom: 0;
            position: relative;
            background-color: rgba(255, 255, 255, 0.03); 
        }
        /* 見出しを暗めに */
        .optional-area .label { color: #777; } 

        /* [修正] 任意エリア内のボタン：背景を暗めに統一 */
        .optional-area .btn {
            background-color: #222; 
            border-color: var(--c-border-light);
            color: #ccc;
        }
        /* [修正] 任意エリア内のボタン選択時: 白背景・黒文字 */
        .optional-area .btn.selected {
            background-color: var(--c-bg-btn-active);
            color: var(--c-text-inverse);
            border-color: var(--c-bg-btn-active);
            opacity: 1;
        }

        .optional-area .input-block { margin-bottom: 24px; }
        .optional-area .input-block:last-child { margin-bottom: 0; }

        .profile-options { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; }
        
        .suspension-area { border: none; padding: 0; margin-bottom: 0; background: transparent; }
        .suspend-btn-container { display: flex; justify-content: center; gap: 10px; }
        
        /* 運営休止ボタンのデザイン統一 */
        .suspend-btn { 
            flex: 1; 
            padding: 10px 0; 
            background-color: #222; /* 背景色統一 */
            border: 1px solid var(--c-border-light); 
            color: #ccc; 
            border-radius: var(--radius-sm); 
            font-size: 0.75rem; 
            cursor: pointer; 
            transition: 0.2s; 
            font-weight: 700;
            font-family: var(--font-main);
        }
        .suspend-btn.active { 
            background: var(--c-caution-bg) !important; 
            border-color: var(--c-caution) !important; 
            color: var(--c-caution) !important; 
            font-weight: bold; 
            opacity: 1;
        }
        
        .memo-area { margin-bottom: 0; }
        /* [修正] 任意エリア内のテキストエリア：背景をボタンと統一、文字サイズ戻し */
        .optional-area textarea { 
            width: 100%; height: 80px; padding: 12px; 
            background: #222; color: #ccc; 
            border: 1px solid #333; border-radius: var(--radius-sm); 
            resize: none; 
            font-size: 0.95rem; /* [修正] 0.75rem -> 0.95rem */
            box-sizing: border-box; font-family: var(--font-main); line-height: 1.5; display: block; 
        }
        .optional-area textarea:focus { border-color: #555; outline: none; }

        /* =========================================
           Log List Styles
           ========================================= */
        .log-list-container { 
            display: flex; 
            flex-direction: column; 
            gap: 10px; 
        }
        
        .shared-content-inner {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .log-list-container > details.daily-log:first-child,
        .shared-content-inner > details.daily-log:first-child { 
            margin-top: 0; 
        }

        details.daily-log { background: var(--c-bg-card); border: 1px solid var(--c-border); border-radius: var(--radius-sm); margin-bottom: 0; overflow: visible; text-align: left; }
        summary.daily-summary { 
            background: #1a1a1a; padding: 12px 15px; 
            cursor: pointer; font-weight: bold; 
            display: flex; align-items: center; color: var(--c-text-accent); 
            list-style: none; border-bottom: 1px solid #222; 
            justify-content: space-between;
            position: sticky; top: 115px; z-index: 5; 
            border-top-left-radius: var(--radius-sm); border-top-right-radius: var(--radius-sm);
        }
        details.daily-log[open] > summary.daily-summary { border-bottom-left-radius: 0; border-bottom-right-radius: 0; }
        details.daily-log:not([open]) > summary.daily-summary { border-bottom-left-radius: var(--radius-sm); border-bottom-right-radius: var(--radius-sm); border-bottom: none; }
        summary.daily-summary::-webkit-details-marker { display: none; }
        
        .summary-left { display: flex; align-items: center; gap: 10px; flex: 1; }
        .summary-left .material-symbols-outlined { transition: transform 0.3s; }
        details.daily-log[open] > summary.daily-summary .summary-left .material-symbols-outlined { transform: rotate(90deg); }
        .summary-info { text-align: left; }
        .summary-date { font-weight: bold; font-size: 1rem; }
        .summary-count { font-size: 0.85rem; color: var(--c-text-secondary); margin-left: 8px; }
        .summary-right { display: flex; align-items: center; gap: 8px; margin-left: auto; }
        
        .publish-status-text { font-size: 0.75rem; color: var(--c-text-muted); font-weight: normal; transition: color 0.2s; }
        .publish-status-text.active { color: var(--c-text-accent); font-weight: bold; }

        .toggle-switch-sm { position: relative; display: inline-block; width: 44px; height: 24px; flex-shrink: 0; }
        .toggle-switch-sm input { opacity: 0; width: 0; height: 0; }
        .slider-sm { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #333; transition: .4s; border-radius: 24px; border: 1px solid #555; }
        .slider-sm:before { position: absolute; content: ""; height: 16px; width: 16px; left: 3px; bottom: 3px; background-color: var(--c-text-sub); transition: .4s; border-radius: 50%; }
        input:checked + .slider-sm { background-color: #ddd; border-color: #fff; }
        input:checked + .slider-sm:before { transform: translateX(19px); background-color: #000; }

        .history-content-wrapper { padding: 10px; background: var(--c-bg-card); border-top: 1px solid #333; min-height: 50px; display: flex; flex-direction: column; justify-content: center; border-bottom-left-radius: var(--radius-sm); border-bottom-right-radius: var(--radius-sm); }
        .log-entry { display: flex; flex-direction: column; border-bottom: 1px solid var(--c-bg-element); padding: 12px 15px; gap: 6px; }
        .log-entry:last-child { border-bottom: none; }
        .log-entry.shared-log-entry { padding: 12px 15px; }

        .log-grid { display: grid; align-items: center; gap: 8px; width: 100%; padding: 0; }
        .log-grid-my { grid-template-columns: 32px 60px 1fr auto; }
        .log-grid-shared { grid-template-columns: 32px 32px 60px 1fr auto; }
        
        .log-time { color: var(--c-text-muted); font-size: 0.85rem; text-align: left; font-weight: bold; margin-top: 2px; }
        .log-count { color: var(--c-text-sub); font-weight: 700; font-size: 1.05rem; text-align: center; margin-right: 4px; line-height: 1.2; }
        .log-content-wrapper { display: flex; flex-direction: column; align-items: flex-start; gap: 2px; overflow: hidden; }
        .log-main-line { display: flex; align-items: baseline; gap: 6px; white-space: nowrap; overflow: hidden; max-width: 100%; }
        .log-memo-line { font-size: 0.75rem; color: var(--c-text-muted); white-space: pre-wrap; word-break: break-all; line-height: 1.3; margin-top: 2px; }
        .text-location { font-size: 1.05rem; font-weight: 700; color: var(--c-text-accent); }
        .text-vehicle { font-size: 1.05rem; font-weight: 700; color: var(--c-text-accent); }
        .log-separator, .log-label-no { color: var(--c-text-muted); font-size: 0.85rem; font-weight: bold; }
        .text-profile { font-size: 0.75rem; color: var(--c-text-muted); margin-left: 4px; } 
        .log-actions { display: flex; gap: 4px; justify-content: flex-end; align-self: center; margin-top: 0; position: relative; }
        .author-icon-list { width: 28px; height: 28px; border-radius: 50%; border: 1px solid var(--c-border-light); object-fit: cover; margin-top: 0; }
        
        .icon-btn { background: transparent; border: none; color: var(--c-text-muted); width: 32px; height: 32px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; }
        .icon-btn:hover { background-color: rgba(255, 255, 255, 0.1); color: var(--c-text-accent); }
        .icon-btn .material-symbols-outlined { font-size: 1.2rem; }

        /* Status Table */
        .status-scroll-wrapper { 
            overflow-x: auto; -webkit-overflow-scrolling: touch; 
            margin-bottom: 20px; border: 1px solid var(--c-border); 
            border-radius: 4px; 
            margin-top: 0; 
        }
        .shared-status-table { width: 100%; border-collapse: collapse; font-size: 0.75rem; }
        .shared-status-table th, .shared-status-table td { border: 1px solid var(--c-border); padding: 10px; text-align: center; color: var(--c-text-main); white-space: nowrap; background-color: var(--c-bg-card); }
        .shared-status-table th { background: var(--c-bg-element); color: var(--c-text-sub); font-weight: bold; position: sticky; top: 0; z-index: 10; }
        .shared-status-table th.fixed-col-date { z-index: 15; left: 0; width: 1px; white-space: nowrap; }
        .shared-status-table td.fixed-col-date { position: sticky; left: 0; background: var(--c-bg-card); z-index: 2; font-weight: bold; color: var(--c-text-accent); border-right: 1px solid var(--c-border-light); width: 1px; white-space: nowrap; }
        .shared-status-table td.td-suspended { color: var(--c-caution); font-weight: bold; }
        .shared-status-table .col-tour { width: 1px; white-space: nowrap; }
        .shared-status-table .th-author { text-align: center; }
        .author-cell { white-space: nowrap; vertical-align: middle; text-align: left; padding: 10px; }
        .author-list { display: flex; flex-direction: row; gap: 4px; align-items: center; flex-wrap: wrap; }
        .author-info-mini { display: flex; align-items: center; gap: 6px; justify-content: flex-start; min-width: 100px; max-width: 120px; padding-left: 4px; }
        .author-icon-mini { width: 22px; height: 22px; border-radius: 50%; border: 1px solid var(--c-border-light); flex-shrink: 0; object-fit: cover; }
        
        .daily-summary-box { padding: 10px; border-bottom: 1px solid #333; background: var(--c-bg-card); }
        .status-table { width: 100%; border-collapse: collapse; margin-top: 0; }
        .status-table th, .status-table td { border: 1px solid #444; padding: 8px; text-align: center; font-size: 0.85rem; color: var(--c-text-main); }
        .status-table th { background: var(--c-bg-element); color: var(--c-text-sub); }
        .profile-badge-small { display: block; font-size: 0.65rem; color: var(--c-text-sub); margin-top: 4px; }
        .th-profile-sub { display: block; font-size: 0.7rem; color: var(--c-text-sub); font-weight: normal; margin-top: 2px; }

        /* FAB */
        .fab {
            position: fixed; bottom: 30px; right: 30px;
            width: 56px; height: 56px; border-radius: 50%;
            background-color: var(--c-text-accent); color: #000;
            border: none; box-shadow: 0 4px 10px rgba(0,0,0,0.5);
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; z-index: 1000; transition: transform 0.2s, background-color 0.2s;
        }
        .fab:active { transform: scale(0.95); }
        .fab:hover { background-color: #ddd; }
        .fab .material-symbols-outlined { font-size: 28px; }

        /* FAB Positioning: default to right bottom, center on larger screens if desired or keep right */
        @media (min-width: 640px) {
            .fab {
                left: 50%;
                right: auto;
                margin-left: 220px; /* Center (300px) - margin(20) - size(56) approx */
            }
        }

        /* Modal */
        .modal-overlay { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0, 0, 0, 0.85); backdrop-filter: blur(5px); 
            z-index: 2000; display: none; 
            opacity: 0; transition: opacity 0.3s;
            /* Default for bottom sheet */
            align-items: flex-end; 
        }
        .modal-overlay.active { display: flex; opacity: 1; }
        
        .modal-content { 
            background: #1a1a1a; width: 100%; max-width: 600px; margin: 0 auto;
            border-radius: 20px 20px 0 0; 
            border: 1px solid #333; border-bottom: none;
            display: flex; flex-direction: column; 
            box-shadow: 0 -5px 25px rgba(0,0,0,0.5); 
            height: auto; max-height: 90vh; 
            overflow: hidden;
            transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
        }
        .modal-overlay.active .modal-content { transform: translateY(0); }
        
        /* [修正] パディング調整 */
        .modal-header { 
            padding: 15px; 
            border-bottom: 1px solid #333; 
            display: flex; justify-content: space-between; align-items: center;
            flex-shrink: 0; 
        }
        
        .modal-body { padding: 15px; flex: 1; overflow-y: auto; }

        .header-submit-btn {
            background: var(--c-bg-element); color: var(--c-text-accent);
            border: 1px solid var(--c-text-accent); border-radius: 9999px; /* カプセル型 */
            padding: 6px 20px; font-size: 0.9rem; font-weight: bold;
            cursor: pointer; transition: all 0.2s;
        }
        .header-submit-btn:disabled { opacity: 0.3; cursor: not-allowed; border-color: var(--c-text-muted); color: var(--c-text-muted); }
        /* [修正] 記録ボタンアクティブ時: 白背景・黒文字 */
        .header-submit-btn:not(:disabled) { 
            background: var(--c-text-accent); 
            color: var(--c-text-inverse); 
        }
        .header-submit-btn:not(:disabled):hover { 
            background: #ddd; /* ホバーで少し暗く */
        }
        
        .header-icon-btn {
            background: transparent; border: none; color: var(--c-text-sub); width: 36px; height: 36px; border-radius: 50%;
            cursor: pointer; display: flex; align-items: center; justify-content: center; transition: background 0.2s;
            padding: 0; /* リセット */
        }
        .header-icon-btn:hover { background: rgba(255, 255, 255, 0.1); color: var(--c-text-accent); }

        /* Confirm Modal */
        .center-overlay { align-items: center; justify-content: center; }
        .center-overlay .modal-content.confirm-modal-content {
            width: 85%; max-width: 320px; height: auto; min-height: auto;
            border-radius: 12px; border: 1px solid var(--c-border-light);
            padding: 24px 20px; text-align: center;
            transform: translateY(20px); transition: transform 0.3s, opacity 0.3s;
            background: #1a1a1a;
        }
        .center-overlay.active .modal-content.confirm-modal-content { transform: translateY(0); opacity: 1; }

        .confirm-body { margin-bottom: 24px; display: flex; flex-direction: column; align-items: center; gap: 15px; }
        .confirm-icon { font-size: 2.5rem; color: var(--c-text-secondary); }
        .confirm-text { font-size: 0.95rem; color: var(--c-text-primary); line-height: 1.6; white-space: pre-wrap; margin: 0; font-family: var(--font-main); }
        .confirm-actions { display: flex; gap: 12px; width: 100%; justify-content: center; }

        .btn-text {
            background: transparent; border: 1px solid var(--c-border-light); color: #aaa;
            padding: 10px 0; border-radius: 6px; cursor: pointer; font-weight: bold;
            transition: 0.2s; flex: 1;
        }
        .btn-text:hover { background: var(--c-bg-hover); color: var(--c-text-accent); }
        .btn-primary {
            background: #e0e0e0; border: none; color: #000;
            padding: 10px 0; border-radius: 6px; cursor: pointer; font-weight: bold;
            transition: 0.2s; flex: 1;
        }
        .btn-primary:hover { background: #fff; box-shadow: 0 0 10px rgba(255,255,255,0.3); }

        .modal-text-input { width: 200px; background: var(--c-bg-element); border: 1px solid var(--c-border-light); color: var(--c-text-accent); padding: 10px; border-radius: 4px; font-size: 1.5rem; text-align: center; font-weight: bold; margin-top: 10px; outline: none; }
        .modal-text-input:focus { border-color: var(--c-text-accent); background: var(--c-bg-hover); }

        .toast {
            position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%) translateY(100px);
            background: rgba(30, 30, 30, 0.95); color: #fff; padding: 12px 24px; border-radius: 30px;
            border: 1px solid #555; font-size: 0.9rem; font-weight: bold; opacity: 0; transition: all 0.4s; z-index: 2000;
            display: flex; align-items: center; gap: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.5);
        }
        .toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }

        /* Action Sheet Styles */
        .action-sheet-list { list-style: none; padding: 0; margin: 0; display: flex; flex-direction: column; }
        .action-sheet-btn {
            background: transparent; border: none; border-bottom: 1px solid var(--c-border);
            color: var(--c-text-main); font-size: 1rem; padding: 16px;
            text-align: left; cursor: pointer; display: flex; align-items: center; gap: 12px;
            transition: background 0.2s; width: 100%;
        }
        .action-sheet-btn:last-child { border-bottom: none; }
        .action-sheet-btn:active { background: var(--c-bg-hover); }
        .action-sheet-btn.delete { color: var(--c-caution); }
        .action-sheet-btn .material-symbols-outlined { font-size: 1.2rem; }

        /* Responsive */
        @media (max-width: 600px) {
            .date-full { display: inline; } 
            .date-short { display: none; }
            .author-name-mini { display: none; }
            .log-actions.desktop-only { display: none !important; }
            .log-actions.mobile-only { display: flex !important; }
            .author-list { flex-direction: row; flex-wrap: wrap; }
        }
        @media (min-width: 601px) {
            .date-full { display: inline; }
            .date-short { display: none; }
            .log-actions.desktop-only { display: flex !important; }
            .log-actions.mobile-only { display: none !important; }
        }
    </style>
</head>
<body>
    <div class="main-wrapper">
        <header class="app-header">
            <div class="header-left">
                <button id="auth-btn" class="auth-btn">
                    <!-- Icon will be injected by JS -->
                    <span class="material-symbols-outlined">account_circle</span>
                </button>
            </div>
            <h1 class="app-title">TOT LOGGER</h1>
            <div class="header-right"></div>
        </header>

        <main class="app-container">
            <!-- タブ -->
            <div class="tab-group sticky-tab">
                 <button class="tab-btn active" data-tab="mylog">マイログ</button>
                 <button class="tab-btn" data-tab="logs">みんなのログ</button>
                 <button class="tab-btn" data-tab="status">運営状況</button>
            </div>
            
            <!-- コンテンツエリア -->
            <div id="main-content-area" class="content-area">
                <div class="log-list-container">
                    <!-- JSでここにコンテンツを描画 -->
                </div>
            </div>
        </main>
        
        <!-- FAB -->
        <button id="fab-add" class="fab" onclick="window.openInputModal()">
            <span class="material-symbols-outlined">add</span>
        </button>

        <!-- Input Modal (Bottom Sheet style) -->
        <div id="input-modal" class="modal-overlay">
            <div class="modal-content">
                <div class="modal-header">
                    <div class="modal-header-left">
                         <button class="header-icon-btn modal-close-btn" onclick="window.closeInputModal()"><span class="material-symbols-outlined">close</span></button>
                    </div>
                    <div class="modal-header-right">
                         <button id="submit-btn" class="header-submit-btn" disabled>記録する</button>
                    </div>
                </div>
                
                <div class="modal-body">
                    <!-- 日付・回数設定 -->
                    <div class="date-counter-area">
                        <div class="date-row"><input type="date" id="visit-date"></div>
                        <div class="counter-ui">
                            <button class="counter-btn" id="btn-count-minus">−</button>
                            <div class="counter-display"><span id="count-val">1</span><span class="unit">回目</span></div>
                            <button class="counter-btn" id="btn-count-plus">＋</button>
                        </div>
                        <div class="time-section-fixed">
                            <div id="time-widget" class="time-widget">
                                <div class="time-placeholder"><span class="material-symbols-outlined">schedule</span> 時刻を追加</div>
                                <div class="time-editor" onclick="event.stopPropagation()">
                                    <input type="time" id="visit-time">
                                    <button class="time-clear-btn"><span class="material-symbols-outlined">close</span></button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 入力フォーム -->
                    <div id="block-floor" class="input-block">
                        <div class="label">
                            <div class="label-left">フロア <span class="error-icon material-symbols-outlined">error</span></div>
                            <span class="label-right">FLOOR</span>
                        </div>
                        <div class="grid-2">
                            <button class="btn floor-btn" id="floor-1" data-floor="1">1F</button>
                            <button class="btn floor-btn" id="floor-2" data-floor="2">2F</button>
                        </div>
                    </div>

                    <div id="block-tour" class="input-block">
                        <div class="label">
                            <div class="label-left">ツアー <span class="error-icon material-symbols-outlined">error</span></div>
                            <span class="label-right">TOUR</span>
                        </div>
                        <div class="grid-3">
                            <button id="tour-btn-A" class="btn tour-btn">A</button>
                            <button id="tour-btn-B" class="btn tour-btn">B</button>
                            <button id="tour-btn-C" class="btn tour-btn">C</button>
                        </div>
                        <div class="status-bar-wrapper">
                            <div class="status-bar"><span id="room-name">フロアを選択</span></div>
                        </div>
                    </div>

                    <div id="block-vehicle" class="input-block">
                        <div class="label">
                            <div class="label-left">機体番号 <span class="error-icon material-symbols-outlined">error</span></div>
                            <span class="label-right">VEHICLE NO.</span>
                        </div>
                        <div id="vehicle-container" class="vehicle-grid"></div>
                    </div>

                    <!-- 任意項目エリア（破線枠） -->
                    <div class="optional-area">
                        <div id="block-profile" class="input-block">
                            <div class="label">
                                <div class="label-left">落下プロファイル <span class="error-icon material-symbols-outlined">error</span></div>
                                <span class="label-right">DROP PROFILE</span>
                            </div>
                            <div class="profile-options">
                                <button id="prof-std" class="btn profile-btn" data-profile="TOWER 1">通常版</button>
                                <button id="prof-l13" class="btn profile-btn" data-profile="TOWER 2">Level 13</button>
                                <button id="prof-shadow" class="btn profile-btn" data-profile="TOWER 3">シャドウ</button>
                                <button id="prof-unknown" class="btn profile-btn" data-profile="UNKNOWN">不明</button>
                            </div>
                        </div>

                        <div class="suspension-area" style="border:none; padding:0; background:transparent; margin-bottom: 24px;">
                            <div class="label">
                                <div class="label-left">運営休止ツアー</div>
                                <span class="label-right">SUSPENDED</span>
                            </div>
                            <div class="suspend-btn-container">
                                <button id="suspend-btn-A" class="suspend-btn">A</button>
                                <button id="suspend-btn-B" class="suspend-btn">B</button>
                                <button id="suspend-btn-C" class="suspend-btn">C</button>
                            </div>
                        </div>

                        <div class="memo-area">
                            <div class="label">
                                <div class="label-left">メモ</div>
                                <span class="label-right">MEMO</span>
                            </div>
                            <textarea id="memo-input" placeholder="メモを入力..." rows="3"></textarea>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Action Sheet Modal -->
        <div id="action-sheet-modal" class="modal-overlay">
            <div class="modal-content">
                <div class="modal-body" style="padding: 0;">
                    <div class="action-sheet-list">
                        <button class="action-sheet-btn" onclick="window.performAction('edit')">
                            <span class="material-symbols-outlined">edit</span> 修正
                        </button>
                        <button class="action-sheet-btn delete" onclick="window.performAction('delete')">
                            <span class="material-symbols-outlined">delete</span> 削除
                        </button>
                        <button class="action-sheet-btn" onclick="window.closeActionSheet()">
                            <span class="material-symbols-outlined">close</span> キャンセル
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- メニュー閉じる用オーバーレイ -->
        <div id="menu-overlay" class="menu-overlay" onclick="window.closeAllMenus()"></div>

        <!-- 確認用モーダル (Center Overlay) -->
        <div id="custom-confirm-modal" class="modal-overlay center-overlay" style="z-index: 2100;">
            <div class="modal-content confirm-modal-content">
                <div class="confirm-body">
                    <span class="material-symbols-outlined confirm-icon">help</span>
                    <p id="confirm-message" class="confirm-text"></p>
                </div>
                <div class="confirm-actions">
                    <button id="confirm-cancel-btn" class="btn-text">キャンセル</button>
                    <button id="confirm-ok-btn" class="btn-primary">OK</button>
                </div>
            </div>
        </div>
        <!-- Footer 削除 -->
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
        import { getFirestore, collection, addDoc, updateDoc, deleteDoc, setDoc, getDocs, getDoc, doc, onSnapshot, query, orderBy, serverTimestamp, where, limit } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
        import { getAuth, onAuthStateChanged, signInWithPopup, TwitterAuthProvider, signOut } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

        // ==========================================
        //  Firebase Configuration
        // ==========================================
        const firebaseConfig = {
          apiKey: "AIzaSyD4OXJQwa2YWfxbGS--qqz9ddi0VNio0xg",
          authDomain: "tot-logger.firebaseapp.com",
          projectId: "tot-logger",
          storageBucket: "tot-logger.firebasestorage.app",
          messagingSenderId: "485860677602",
          appId: "1:485860677602:web:e11380515fd9f1805ecbbb"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // Constants
        const CONSTANTS = {
            ROOMS: { 'A-1': '絵画', 'A-2': '古代の武器', 'B-1': '鎧', 'B-2': '建築工芸品', 'C-1': 'タペストリー', 'C-2': '仮面' },
            PROFILES: { 'TOWER 1': '通常版', 'TOWER 2': 'Level 13', 'TOWER 3': 'シャドウ', 'UNKNOWN': '不明' },
            MESSAGES: {
                loginRequired: "サインインが必要です",
                saveSuccess: "記録しました",
                updateSuccess: "修正しました",
                confirmDelete: "削除しますか？",
                confirmReset: "日付を変更しますか？（入力内容と推奨設定がリセットされます）",
                vehicle7Caution: "7号機は消失したと言われています。記録しますか？",
                vehicleEmptyCaution: "機体番号が未選択です。「不明」として記録しますか？",
                confirmEdit: "修正モードを開きますか？",
                confirmPublish: "この記録を「みんなのログ」に公開しますか？",
                confirmUnpublish: "非公開にしますか？",
                confirmLogout: "サインアウトしますか？",
                usedVehicleCaution: "この機体番号は本日すでに別の乗り場で記録されています。記録しますか？"
            }
        };

        // State
        const State = {
            user: null, logs: [], specialSchedules: [], publishedDates: new Set(), openHistoryDates: new Set(),
            input: { count: 1, floor: null, tour: null, vehicle: null, profile: null, suspendedTours: [], memo: '' },
            editingId: null, lastScrollPos: 0, isTimeInputVisible: false, scrollToId: null, sharedReports: [], 
            currentSharedTab: 'mylog',
            lastSharedScrollPos: null,
            isEditingFromShared: false,
            targetLogId: null // For Action Sheet
        };

        // Function Declarations (Global)
        
        window.getPaths = (userId) => {
            if (!userId) return null;
            return { logs: collection(db, 'users', userId, 'logs'), shared: collection(db, 'shared_reports') };
        };

        const Logic = {
            // ローカル時間のYYYY-MM-DDを取得
            getTodayStr: () => {
                const d = new Date();
                const year = d.getFullYear();
                const month = ('0' + (d.getMonth() + 1)).slice(-2);
                const day = ('0' + d.getDate()).slice(-2);
                return `${year}-${month}-${day}`;
            },
            getCurrentTimeStr: () => new Date().toTimeString().slice(0, 5),
            getProgramType(dateStr) {
                if (!State.specialSchedules || State.specialSchedules.length === 0) return null;
                const target = State.specialSchedules.find(s => dateStr >= s.start && dateStr <= s.end);
                return target ? target.type : null;
            },
            calculateNextState(dateStr) {
                const dayLogs = State.logs.filter(l => l.date === dateStr);
                if (dayLogs.length === 0) return { count: 1, suspendedTours: [] };
                const maxLog = dayLogs.reduce((prev, curr) => (prev.count > curr.count) ? prev : curr);
                return { count: maxLog.count + 1, suspendedTours: maxLog.suspended || [] };
            },
            calculateDailyState(dateVal, excludeId = null) {
                const dayLogs = State.logs.filter(l => l.date === dateVal && l.id !== excludeId);
                const assignments = {};
                const suspendedSet = new Set();
                const shaftHistory = { A: null, B: null, C: null };

                dayLogs.forEach(log => {
                    if (log.tour && log.floor && log.vehicle) {
                        assignments[`${log.tour}-${log.floor}`] = log.vehicle;
                    }
                    if (log.suspended) log.suspended.forEach(t => suspendedSet.add(t));
                    if (log.tour) suspendedSet.delete(log.tour);
                    if (log.tour && log.profile && log.profile !== 'UNKNOWN') shaftHistory[log.tour] = log.profile;
                });
                
                return { assignments, suspended: { A: suspendedSet.has('A'), B: suspendedSet.has('B'), C: suspendedSet.has('C') }, shaftHistory };
            },
            analyzeProfileStatus(dateStr, tour) {
                const daily = this.calculateDailyState(dateStr, State.editingId);
                
                if (daily.shaftHistory[tour]) {
                    const established = daily.shaftHistory[tour];
                    const allProfiles = Object.keys(CONSTANTS.PROFILES);
                    return { 
                        defaultProfile: established, 
                        cautionProfiles: allProfiles.filter(k => k !== established) 
                    };
                }

                const program = this.getProgramType(dateStr);
                
                if (program === 'L13') {
                    return { defaultProfile: 'TOWER 2', cautionProfiles: ['TOWER 1', 'TOWER 3', 'UNKNOWN'] };
                }
                
                if (program === 'SHADOW') {
                    return { defaultProfile: 'TOWER 3', cautionProfiles: ['TOWER 1', 'TOWER 2', 'UNKNOWN'] };
                }
                
                const month = parseInt(dateStr.split('-')[1], 10);
                const isSpring = (month >= 1 && month <= 4);
                
                if (program === 'UNLIMITED' || (!program && isSpring)) {
                    return { defaultProfile: 'UNKNOWN', cautionProfiles: [] };
                }
                
                return { defaultProfile: 'TOWER 1', cautionProfiles: ['TOWER 2', 'TOWER 3', 'UNKNOWN'] };
            }
        };

        function formatDate(dateStr) {
            const parts = dateStr.split('-');
            return `<span class="date-full">${dateStr.replace(/-/g, '/')}</span>`;
        }

        function generateDailySummaryHTML(logs, dateStr, externalSuspended = null) {
            const tourData = { A: {floors:{}, profiles:new Set()}, B: {floors:{}, profiles:new Set()}, C: {floors:{}, profiles:new Set()} };
            const suspended = { A: false, B: false, C: false };
            if (externalSuspended) externalSuspended.forEach(t => suspended[t] = true);
            
            logs.forEach(log => {
                if(!tourData[log.tour]) return;
                if (log.floor && log.vehicle) tourData[log.tour].floors[log.floor] = log.vehicle;
                if (log.suspended) log.suspended.forEach(t => suspended[t] = true);
                if (log.profile) tourData[log.tour].profiles.add(log.profile); 
            });

            const getCell = (tour, floor) => {
                if (suspended[tour]) return '<span style="color:#ff5555;">×</span>';
                const v = tourData[tour].floors[floor];
                return v ? `<span style="font-weight:bold;">${v}</span>` : '-';
            };

            const program = Logic.getProgramType(dateStr);
            const month = parseInt(dateStr.split('-')[1], 10);
            const isSpring = (month >= 1 && month <= 4);
            const showProfiles = (program === 'UNLIMITED' || (!program && isSpring));

            const getProfileDisplay = (tour) => {
                if (!showProfiles) return '';
                if (suspended[tour]) return '<br><span class="th-profile-sub">-</span>';
                
                const profiles = Array.from(tourData[tour].profiles);
                const visibleProfiles = profiles.filter(p => p !== 'UNKNOWN');
                
                if (visibleProfiles.length === 0 && profiles.includes('UNKNOWN')) {
                    visibleProfiles.push('UNKNOWN');
                }
                
                if (visibleProfiles.length === 0) return '<br><span class="th-profile-sub">-</span>';
                
                const displayNames = visibleProfiles.map(p => CONSTANTS.PROFILES[p] || p);
                return `<br><span class="th-profile-sub">${displayNames.join('・')}</span>`;
            };

            return `
            <div class="daily-summary-box">
                <table class="status-table">
                    <thead>
                        <tr>
                            <th class="row-header"></th>
                            <th>TOUR A${getProfileDisplay('A')}</th>
                            <th>TOUR B${getProfileDisplay('B')}</th>
                            <th>TOUR C${getProfileDisplay('C')}</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr><th class="row-header">2F</th><td>${getCell('A', 2)}</td><td>${getCell('B', 2)}</td><td>${getCell('C', 2)}</td></tr>
                        <tr><th class="row-header">1F</th><td>${getCell('A', 1)}</td><td>${getCell('B', 1)}</td><td>${getCell('C', 1)}</td></tr>
                    </tbody>
                </table>
            </div>`;
        }

        // Global functions
        window.closeAllMenus = () => {
            // Not used anymore
        };

        window.openInputModal = (withReset = true) => {
            document.getElementById('input-modal').classList.add('active');
            if (withReset) {
                UIManager.resetInput(); 
            }
            // スクロール位置をリセット
            const body = document.querySelector('.modal-body');
            if(body) body.scrollTop = 0;
        };
        
        window.closeInputModal = () => {
            document.getElementById('input-modal').classList.remove('active');
            UIManager.resetInput();
        };

        // Action Sheet Logic
        window.openActionSheet = (logId) => {
            State.targetLogId = logId;
            document.getElementById('action-sheet-modal').classList.add('active');
        };

        window.closeActionSheet = () => {
            document.getElementById('action-sheet-modal').classList.remove('active');
            State.targetLogId = null;
        };

        window.performAction = (action) => {
            const id = State.targetLogId;
            window.closeActionSheet();
            if (!id) return;

            if (action === 'edit') {
                window.handleEditLog(id);
            } else if (action === 'delete') {
                window.handleDeleteLog(id);
            }
        };
        
        window.handleTourSelect = (t) => {
            State.input.tour = State.input.tour === t ? null : t;
            if (State.input.tour) {
                const analysis = Logic.analyzeProfileStatus(UIManager.els.date.value, State.input.tour);
                if (!State.input.profile || State.input.profile === 'UNKNOWN') {
                    if (analysis.defaultProfile) {
                        State.input.profile = analysis.defaultProfile;
                    }
                }
            }
            UIManager.updateAll();
        };

        window.handleProfileSelect = async (p) => {
            if (State.input.tour) {
                const analysis = Logic.analyzeProfileStatus(UIManager.els.date.value, State.input.tour);
                if (analysis.cautionProfiles.includes(p)) {
                    if (!await UIManager.showConfirmModal(`推奨設定とは異なります。\n「${CONSTANTS.PROFILES[p]}」を選択しますか？`)) return;
                }
            }
            State.input.profile = p;
            UIManager.updateAll();
        };

        window.saveLog = async function() {
            if (!State.user) return UIManager.showToast("サインインが必要です");
            const s = State.input;
            if (!s.floor || !s.tour || !s.vehicle || !s.profile) {
                UIManager.showToast("入力が不足しています"); return;
            }
            
            const dateVal = UIManager.els.date.value;
            if (!State.editingId && State.publishedDates.has(dateVal)) {
                if (!await UIManager.showConfirmModal("この日付は公開中です。\n記録を追加して公開データを更新しますか？")) return;
            }

            UIManager.setLoading(true);
            const data = {
                date: dateVal, time: State.isTimeInputVisible ? UIManager.els.time.value : '',
                count: s.count, floor: s.floor, tour: s.tour, vehicle: s.vehicle, profile: s.profile,
                suspended: s.suspendedTours, memo: UIManager.els.memo.value, author: { uid: State.user.uid, name: State.user.displayName, photoURL: State.user.photoURL }
            };
            try {
                if (State.editingId) await updateDoc(doc(db, 'users', State.user.uid, 'logs', State.editingId), data);
                else await addDoc(collection(db, 'users', State.user.uid, 'logs'), { ...data, createdAt: serverTimestamp() });
                if (State.publishedDates.has(data.date)) await window.syncSharedReport(data.date);
                UIManager.showToast(State.editingId ? "修正しました" : "保存完了"); 
                window.closeInputModal(); 
            } catch (e) { console.error(e); UIManager.showToast("保存失敗: " + e.code); } 
            finally { UIManager.setLoading(false); }
        };
        
        window.loadSharedReports = async () => {
             window.isLoadingShared = true;
             try {
                 const q = query(collection(db, 'shared_reports'), orderBy('date', 'desc'), limit(50));
                 const snapshot = await getDocs(q);
                 State.sharedReports = snapshot.docs.map(d => d.data());
             } catch(e) {
                 console.error(e);
             } finally {
                 window.isLoadingShared = false;
                 window.renderMainContent(); 
             }
        };

        window.handleAuthClick = async () => {
            if (State.user) {
                if (await UIManager.showConfirmModal(CONSTANTS.MESSAGES.confirmLogout)) {
                    try { await signOut(auth); } catch (e) { console.error(e); }
                }
            } else {
                try { await signInWithPopup(auth, new TwitterAuthProvider()); }
                catch (error) { console.error(error); UIManager.showToast("ログイン失敗"); }
            }
        };

        window.renderMainContent = () => {
            const container = document.querySelector('.log-list-container');
            if (!container) return;
            container.innerHTML = ''; 

            if (State.currentSharedTab === 'mylog') {
                UIManager.renderHistory(container);
            } else {
                if (State.sharedReports.length === 0 && !window.isLoadingShared) {
                     window.loadSharedReports();
                     container.innerHTML = '<div class="status-message">読み込み中...</div>';
                     return;
                }
                UIManager.renderSharedContent(container);
            }
        };
        
        window.syncSharedReport = async (dateStr) => {
            const dailyData = Logic.calculateDailyState(dateStr);
            const logs = State.logs.filter(l => l.date === dateStr);
            
            if (logs.length === 0) {
                try {
                    await deleteDoc(doc(db, 'shared_reports', dateStr + "_" + State.user.uid));
                    State.publishedDates.delete(dateStr);
                } catch(e) {}
                return;
            }

            const summary = { A: {}, B: {}, C: {} };
            logs.forEach(l => { if(l.tour && l.floor && l.vehicle) summary[l.tour][l.floor] = l.vehicle; });
            
            const reportData = {
                date: dateStr, summary: summary,
                author: { uid: State.user.uid, name: State.user.displayName || "NoName", photoURL: State.user.photoURL },
                updatedAt: serverTimestamp(),
                suspended: Array.from(Object.keys(dailyData.suspended).filter(k=>dailyData.suspended[k])),
                logs: logs.map(l => ({ id: l.id, time: l.time, count: l.count, tour: l.tour, floor: l.floor, vehicle: l.vehicle, profile: l.profile, memo: l.memo })) 
            };
            
            await setDoc(doc(db, 'shared_reports', dateStr + "_" + State.user.uid), reportData); 
        };

        window.handleTogglePublish = async (dateStr, checkbox) => {
            const isChecked = checkbox.checked;
            if (isChecked) {
                if (!await UIManager.showConfirmModal(CONSTANTS.MESSAGES.confirmPublish)) {
                    checkbox.checked = false; 
                    return;
                }
                try {
                    await window.syncSharedReport(dateStr);
                    State.publishedDates.add(dateStr);
                    UIManager.showToast("公開しました");
                } catch (error) {
                    console.error("Publish Error:", error);
                    checkbox.checked = false;
                    State.publishedDates.delete(dateStr);
                    UIManager.showToast("公開失敗");
                }
            } else {
                if (!await UIManager.showConfirmModal(CONSTANTS.MESSAGES.confirmUnpublish)) {
                     checkbox.checked = true;
                     return;
                }
                try {
                    await deleteDoc(doc(db, 'shared_reports', dateStr + "_" + State.user.uid));
                    State.publishedDates.delete(dateStr);
                    UIManager.showToast("非公開にしました");
                } catch(e) { 
                    console.error("Unpublish Error:", e);
                    checkbox.checked = true; 
                    UIManager.showToast("エラー"); 
                }
            }
            window.renderMainContent(); 
        };

        window.handleDeleteLog = async (id) => {
            if (await UIManager.showConfirmModal("削除しますか？")) {
                const logToDelete = State.logs.find(l => l.id === id);
                if (!logToDelete) return;
                const dateToDelete = logToDelete.date;
                await deleteDoc(doc(db, 'users', State.user.uid, 'logs', id));
                
                if (State.publishedDates.has(dateToDelete)) {
                    await window.syncSharedReport(dateToDelete);
                }
                
                State.sharedReports = State.sharedReports.map(report => {
                    if (report.date === dateToDelete && report.author.uid === State.user.uid) {
                        const newLogs = report.logs.filter(l => l.id !== id);
                        if (newLogs.length === 0) return null;
                        const newSummary = { A: {}, B: {}, C: {} };
                        newLogs.forEach(l => { if(l.tour && l.floor && l.vehicle) newSummary[l.tour][l.floor] = l.vehicle; });
                        return { ...report, logs: newLogs, summary: newSummary };
                    }
                    return report;
                }).filter(Boolean);

                UIManager.showToast("削除しました");
                window.renderMainContent(); 
            }
        };

        window.handleEditLog = async (id) => {
            const log = State.logs.find(l => l.id === id);
            
            if (log) {
                State.editingId = id; State.input = { ...log, suspendedTours: log.suspended || [] };
                UIManager.els.date.value = log.date;
                if (log.time) { UIManager.els.time.value = log.time; State.isTimeInputVisible = true; } else { State.isTimeInputVisible = false; }
                
                window.openInputModal();
                UIManager.updateAll(); 
            }
        };

        window.handleVehicleClick = async (num, confirmMsg) => {
            if (State.input.vehicle == num) { State.input.vehicle = null; UIManager.updateAll(); return; }
            if (confirmMsg && !await UIManager.showConfirmModal(confirmMsg)) return;
            State.input.vehicle = num;
            UIManager.updateAll();
        };

        const UIManager = {
            els: {},
            init() {
                this.els = {
                    date: document.getElementById('visit-date'), time: document.getElementById('visit-time'), count: document.getElementById('count-val'),
                    roomName: document.getElementById('room-name'), memo: document.getElementById('memo-input'),
                    vehicleContainer: document.getElementById('vehicle-container'), 
                    submitBtn: document.getElementById('submit-btn')
                };
                this.els.date.value = Logic.getTodayStr();
                this.handleDateChange(false);
                
                // タブ初期化
                document.querySelectorAll('.tab-btn').forEach(btn => {
                    btn.onclick = async (e) => {
                        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                        e.target.classList.add('active'); 
                        const tab = e.target.dataset.tab;
                        State.currentSharedTab = tab;
                        
                        if (tab !== 'mylog') {
                            const container = document.querySelector('.log-list-container');
                            if(container) container.innerHTML = '<div class="status-message">読み込み中...</div>';
                            await window.loadSharedReports();
                        } else {
                            window.renderMainContent();
                        }
                    };
                });
            },
            initSwipeTabNavigation() {
                let startX = 0;
                let startY = 0;
                const wrapper = document.querySelector('.main-wrapper');
                
                wrapper.addEventListener('touchstart', (e) => {
                    startX = e.touches[0].clientX;
                    startY = e.touches[0].clientY;
                }, { passive: true });

                wrapper.addEventListener('touchend', (e) => {
                    const endX = e.changedTouches[0].clientX;
                    const endY = e.changedTouches[0].clientY;
                    const diffX = endX - startX;
                    const diffY = endY - startY;

                    if (Math.abs(diffX) > 80 && Math.abs(diffY) < 50) {
                        const tabs = ['mylog', 'logs', 'status'];
                        const currentIndex = tabs.indexOf(State.currentSharedTab);
                        let nextIndex = currentIndex;

                        if (diffX < 0 && currentIndex < tabs.length - 1) {
                            nextIndex++; // Left swipe -> Next tab
                        } else if (diffX > 0 && currentIndex > 0) {
                            nextIndex--; // Right swipe -> Prev tab
                        }

                        if (nextIndex !== currentIndex) {
                            const nextTab = tabs[nextIndex];
                            const btn = document.querySelector(`.tab-btn[data-tab="${nextTab}"]`);
                            if (btn) btn.click();
                        }
                    }
                });
            },
            updateAll() {
                if(document.getElementById('input-modal').classList.contains('active')){
                    this.updateRoomDisplay(); this.updateSelectionStyles(); this.updateVehicleGrid(); 
                    this.els.count.innerText = State.input.count; this.els.memo.value = State.input.memo;
                    this.updateEditModeUI(); this.updateTimeUI();
                }
                
                window.renderMainContent();
            },
            updateTimeUI() {
                const w = document.getElementById('time-widget');
                State.isTimeInputVisible ? w.classList.add('active') : w.classList.remove('active');
            },
            activateTimeInput() {
                State.isTimeInputVisible = true;
                if (!this.els.time.value) this.els.time.value = Logic.getCurrentTimeStr();
                this.updateAll();
                setTimeout(() => { 
                    this.els.time.focus(); 
                    if('showPicker' in HTMLInputElement.prototype) {
                        try { this.els.time.showPicker(); } catch(e){}
                    }
                }, 100);
            },
            deactivateTimeInput() { State.isTimeInputVisible = false; this.els.time.value = ''; this.updateAll(); },
            async handleDateChange(showConfirm = true) {
                if (showConfirm && !await this.showConfirmModal(CONSTANTS.MESSAGES.confirmReset)) return;
                this.resetInput(true);
            },
            resetInput(clearSuspended = false) {
                const wasEditing = !!State.editingId;
                State.editingId = null;
                const dateVal = this.els.date.value;
                const nextState = Logic.calculateNextState(dateVal);
                State.input = { count: nextState.count, floor: null, tour: null, vehicle: null, profile: null, suspendedTours: clearSuspended ? [] : nextState.suspendedTours, memo: '' };
                this.deactivateTimeInput(); this.updateAll();
                ['block-floor', 'block-tour', 'block-vehicle', 'block-profile'].forEach(id => {
                    const el = document.getElementById(id);
                    if(el) el.classList.remove('input-missing');
                });
            },
            setLoading(loading) { 
                if (this.els.submitBtn) {
                    this.els.submitBtn.classList.toggle('loading', loading); 
                }
            },
            updateRoomDisplay() {
                const { tour, floor } = State.input;
                if (tour && floor) { this.els.roomName.innerText = CONSTANTS.ROOMS[`${tour}-${floor}`] || `${tour}-${floor}`; this.els.roomName.style.color = "#fff"; }
                else { this.els.roomName.innerText = floor ? "ツアーを選択" : "フロアを選択"; this.els.roomName.style.color = "#555"; }
            },
            updateSelectionStyles() {
                const s = State.input;
                const daily = Logic.calculateDailyState(this.els.date.value, State.editingId);
                if(s.floor) document.getElementById('block-floor').classList.remove('input-missing');
                if(s.tour) document.getElementById('block-tour').classList.remove('input-missing');
                if(s.vehicle) document.getElementById('block-vehicle').classList.remove('input-missing');
                if(s.profile) document.getElementById('block-profile').classList.remove('input-missing');
                document.querySelectorAll('.floor-btn').forEach(b => b.classList.toggle('selected', s.floor == b.dataset.floor));
                ['A', 'B', 'C'].forEach(t => {
                    const b = document.getElementById(`tour-btn-${t}`);
                    if (b) {
                        b.classList.toggle('selected', s.tour === t);
                        b.classList.toggle('btn-suspended-view', s.suspendedTours.includes(t));
                        b.classList.toggle('btn-caution', !s.suspendedTours.includes(t) && daily.suspended[t]);
                    }
                });
                const analysis = s.tour ? Logic.analyzeProfileStatus(this.els.date.value, s.tour) : { cautionProfiles: [] };
                document.querySelectorAll('.profile-btn').forEach(b => {
                    b.classList.toggle('selected', s.profile === b.dataset.profile);
                    b.classList.toggle('btn-caution', analysis.cautionProfiles.includes(b.dataset.profile));
                });
                ['A', 'B', 'C'].forEach(t => document.getElementById(`suspend-btn-${t}`).classList.toggle('active', s.suspendedTours.includes(t)));
            },
            updateVehicleGrid() {
                const container = this.els.vehicleContainer; container.innerHTML = '';
                const { tour, floor } = State.input;
                const currentKey = (tour && floor) ? `${tour}-${floor}` : null;
                const daily = Logic.calculateDailyState(this.els.date.value, State.editingId);
                const usedInOtherPlaces = new Set();
                if (currentKey) {
                    Object.entries(daily.assignments).forEach(([key, val]) => {
                        if (key !== currentKey) usedInOtherPlaces.add(parseInt(val));
                    });
                }

                for (let i = 1; i <= 9; i++) {
                    const btn = document.createElement('button'); btn.className = 'btn vehicle-btn';
                    if (i === 9) {
                        btn.classList.add('btn-caution');
                        btn.innerHTML = '<span style="font-size: 0.9rem;">不明</span>';
                        if (State.input.vehicle === '不明') btn.classList.add('selected');
                        btn.onclick = () => window.handleVehicleClick('不明', false, false);
                    } else {
                        btn.innerHTML = i;
                        let caution = (i === 7 || (currentKey && daily.assignments[currentKey] && daily.assignments[currentKey] != i));
                        let isUsedElsewhere = usedInOtherPlaces.has(i);
                        if (isUsedElsewhere) btn.classList.add('btn-used'); else if (caution) btn.classList.add('btn-caution');
                        if (State.input.vehicle == i) btn.classList.add('selected');
                        btn.addEventListener('click', () => {
                            let msg = null;
                            if (i === 7) msg = CONSTANTS.MESSAGES.vehicle7Caution;
                            if (isUsedElsewhere) msg = CONSTANTS.MESSAGES.usedVehicleCaution;
                            if (!msg && caution && daily.assignments[currentKey]) {
                                const oldVal = daily.assignments[currentKey];
                                msg = `この乗り場には既に No.${oldVal} が登録されています。No.${i} に変更しますか？`;
                            }
                            window.handleVehicleClick(i, msg);
                        });
                    }
                    container.appendChild(btn);
                }
            },
            updateEditModeUI() {
                const s = State.input;
                const isValid = s.floor && s.tour && s.vehicle && s.profile;
                const btn = document.getElementById('submit-btn');
                if (btn) {
                    btn.disabled = !isValid;
                    btn.innerText = State.editingId ? "修正する" : "記録する";
                }
            },
            renderHistory(container) {
                if (!State.logs.length) { 
                    container.innerHTML = "<div class='status-message'>記録なし</div>"; 
                    return; 
                }
                const groups = {}; State.logs.forEach(l => { if (!groups[l.date]) groups[l.date] = []; groups[l.date].push(l); });
                
                let html = '';
                const sortedDates = Object.keys(groups).sort((a,b)=>b.localeCompare(a));
                const todayStr = Logic.getTodayStr();
                const todayLogs = groups[todayStr];
                
                // Today's Logs
                if (todayLogs) {
                     const isPub = State.publishedDates.has(todayStr);
                     const summaryHTML = generateDailySummaryHTML(todayLogs, todayStr);
                     const dateDisplay = todayStr.replace(/-/g, '/');
                     html += `<details class="daily-log" open data-date="${todayStr}">
                        <summary class="daily-summary">
                            <div class="summary-left">
                                <span class="material-symbols-outlined">chevron_right</span>
                                <div class="summary-info"><span class="summary-date">${dateDisplay}</span> <span class="summary-count">${todayLogs.length}件</span></div>
                            </div>
                            <div class="summary-right">
                                <span class="publish-status-text ${isPub ? 'active' : ''}">${isPub ? '公開中' : '非公開'}</span>
                                <label class="toggle-switch-sm" onclick="event.stopPropagation();">
                                    <input type="checkbox" ${isPub ? 'checked' : ''} onchange="window.handleTogglePublish('${todayStr}', this)">
                                    <span class="slider-sm"></span>
                                </label>
                            </div>
                        </summary>
                        <div class="history-content">
                            ${summaryHTML}
                            <div class="log-list">`;
                     // [修正] 降順ソート
                     todayLogs.sort((a,b)=>b.count-a.count).forEach(l => {
                        html += this.createLogEntryHTML(l, true); 
                     });
                     html += `</div></div></details>`;
                }
                
                // Past Logs
                const pastDates = sortedDates.filter(d => d !== todayStr);
                if (pastDates.length > 0) {
                    html += `<div class="past-log-label">過去のログ</div>`;
                    pastDates.forEach(date => {
                        const isPub = State.publishedDates.has(date);
                        const logs = groups[date];
                        const summaryHTML = generateDailySummaryHTML(logs, date);
                        const dateDisplay = date.replace(/-/g, '/');
                        html += `<details class="daily-log" data-date="${date}">
                        <summary class="daily-summary">
                            <div class="summary-left">
                                <span class="material-symbols-outlined">chevron_right</span>
                                <div class="summary-info"><span class="summary-date">${dateDisplay}</span> <span class="summary-count">${logs.length}件</span></div>
                            </div>
                            <div class="summary-right">
                                <span class="publish-status-text ${isPub ? 'active' : ''}">${isPub ? '公開中' : '非公開'}</span>
                                <label class="toggle-switch-sm" onclick="event.stopPropagation();">
                                    <input type="checkbox" ${isPub ? 'checked' : ''} onchange="window.handleTogglePublish('${date}', this)">
                                    <span class="slider-sm"></span>
                                </label>
                            </div>
                        </summary>
                        <div class="history-content">
                            ${summaryHTML}
                            <div class="log-list">`;
                        logs.sort((a,b)=>b.count-a.count).forEach(l => {
                            html += this.createLogEntryHTML(l, true); 
                        });
                        html += `</div></div></details>`;
                    });
                }
                container.innerHTML = html;
                container.querySelectorAll('details.daily-log').forEach(el => el.addEventListener('toggle', () => el.open ? State.openHistoryDates.add(el.dataset.date) : State.openHistoryDates.delete(el.dataset.date)));
            },
            
            createLogEntryHTML(l, isMyLog) {
                const vehicleStr = l.vehicle ? l.vehicle : '--';
                const profileName = (l.profile && l.profile !== 'UNKNOWN' && l.profile !== 'TOWER 1') ? CONSTANTS.PROFILES[l.profile] : '';
                const memoHtml = l.memo ? `<div class="log-memo-line">${l.memo}</div>` : '';
                return `
                        <div class="log-entry ${!isMyLog ? 'shared-log-entry' : ''}" id="log-${l.id}">
                            <div class="log-grid ${isMyLog ? 'log-grid-my' : 'log-grid-shared'}">
                                ${ !isMyLog ? `<img src="${l.author.photoURL || ''}" class="author-icon-list" onerror="this.style.display='none'">` : '' }
                                <div class="log-count">#${l.count}</div>
                                <div class="log-time">${l.time||'--:--'}</div>
                                <div class="log-content-wrapper">
                                    <div class="log-main-line">
                                        <span class="text-location">${l.tour}-${l.floor}F</span> <span class="log-separator">/</span> <span class="log-label-no">No.</span><span class="text-vehicle">${vehicleStr}</span>${profileName ? `<span class="text-profile">(${profileName})</span>` : ''}
                                    </div>
                                    ${memoHtml}
                                </div>
                                ${ isMyLog ? `
                                 <div class="log-actions mobile-only" style="display:flex;">
                                     <button class="icon-btn" onclick="window.openActionSheet('${l.id}')"><span class="material-symbols-outlined">more_vert</span></button>
                                 </div>
                                 <div class="log-actions desktop-only">
                                    <button class="icon-btn" onclick="window.handleEditLog('${l.id}')"><span class="material-symbols-outlined">edit</span></button>
                                    <button class="icon-btn" onclick="window.handleDeleteLog('${l.id}')"><span class="material-symbols-outlined">delete</span></button>
                                 </div>` : '' }
                            </div>
                        </div>`;
            },
            
            renderSharedContent(container) {
                if (State.sharedReports.length === 0) {
                    container.innerHTML = `<div class="status-message">データがありません</div>`;
                    return;
                }

                if (State.currentSharedTab === 'status') {
                    const groupedReports = {};
                    const sortedReports = [...State.sharedReports].sort((a,b) => b.date.localeCompare(a.date));
                    sortedReports.forEach(r => { if (!groupedReports[r.date]) groupedReports[r.date] = []; groupedReports[r.date].push(r); });

                    let html = `
                    <div class="status-scroll-wrapper">
                        <table class="shared-status-table">
                            <thead>
                                <tr>
                                    <th rowspan="2" class="fixed-col-date">日付</th>
                                    <th colspan="2">TOUR A</th>
                                    <th colspan="2">TOUR B</th>
                                    <th colspan="2">TOUR C</th>
                                    <th rowspan="2" class="th-author">投稿者</th>
                                </tr>
                                <tr>
                                    <th class="col-tour">1F</th><th class="col-tour">2F</th>
                                    <th class="col-tour">1F</th><th class="col-tour">2F</th>
                                    <th class="col-tour">1F</th><th class="col-tour">2F</th>
                                </tr>
                            </thead>
                            <tbody>`;
                    
                    Object.keys(groupedReports).forEach(date => {
                        const dailyReports = groupedReports[date].sort((a,b) => (b.author.uid || "").localeCompare(a.author.uid || ""));
                        const getMergedVal = (tour, floor) => {
                            const values = new Set();
                            dailyReports.forEach(r => {
                                const s = r.summary || { A: {}, B: {}, C: {} };
                                const suspended = r.suspended || [];
                                let val = '-';
                                if (suspended.includes(tour)) val = '<span class="td-suspended" style="color:#ff5555;">×</span>';
                                else if (s[tour] && s[tour][floor]) val = s[tour][floor];
                                values.add(val);
                            });
                            return Array.from(values).join('<br>');
                        };
                        let authorsHtml = '<div class="author-list">';
                        dailyReports.forEach(r => { authorsHtml += `<img src="${r.author.photoURL || ''}" class="author-icon-mini" onerror="this.style.display='none'" title="${r.author.name}">`; });
                        authorsHtml += '</div>';
                        html += `<tr><td class="fixed-col-date">${formatDate(date)}</td><td class="col-tour">${getMergedVal('A', 1)}</td><td class="col-tour">${getMergedVal('A', 2)}</td><td class="col-tour">${getMergedVal('B', 1)}</td><td class="col-tour">${getMergedVal('B', 2)}</td><td class="col-tour">${getMergedVal('C', 1)}</td><td class="col-tour">${getMergedVal('C', 2)}</td><td class="author-cell">${authorsHtml}</td></tr>`;
                    });
                    html += `</tbody></table></div>`;
                    container.innerHTML = html;
                } else {
                    const allLogs = [];
                    State.sharedReports.forEach(report => {
                        if (report.logs) {
                            report.logs.forEach(log => { allLogs.push({ ...log, date: report.date, author: report.author }); });
                        }
                    });
                    allLogs.sort((a, b) => b.date.localeCompare(a.date) || (b.time || "").localeCompare(a.time || ""));
                    const groupedLogs = {};
                    allLogs.forEach(log => { if (!groupedLogs[log.date]) groupedLogs[log.date] = []; groupedLogs[log.date].push(log); });
                    
                    let html = `<div class="shared-content-inner">`; 
                    const sortedDates = Object.keys(groupedLogs).sort((a,b)=>b.localeCompare(a));
                    const todayStr = Logic.getTodayStr();
                    
                    if(groupedLogs[todayStr]) {
                        const dailyLogs = groupedLogs[todayStr].sort((a, b) => (b.count || 0) - (a.count || 0));
                        html += this.createSharedDailyLogHTML(todayStr, dailyLogs, true);
                    }
                    
                    const pastDates = sortedDates.filter(d => d !== todayStr);
                    if (pastDates.length > 0) {
                        html += `<div class="past-log-label">過去のログ</div>`;
                        pastDates.forEach(date => {
                            const dailyLogs = groupedLogs[date].sort((a, b) => (b.count || 0) - (a.count || 0));
                            html += this.createSharedDailyLogHTML(date, dailyLogs, false);
                        });
                    }
                    html += `</div>`;
                    container.innerHTML = html;
                }
            },
            
            createSharedDailyLogHTML(date, dailyLogs, isOpen) {
                const dateDisplay = date.replace(/-/g, '/');
                let html = `<details class="daily-log" ${isOpen ? 'open' : ''} data-date="${date}">
                            <summary class="daily-summary">
                                <div class="summary-left">
                                    <span class="material-symbols-outlined">chevron_right</span>
                                    <div class="summary-info"><span class="summary-date">${dateDisplay}</span> <span class="summary-count">${dailyLogs.length}件</span></div>
                                </div>
                            </summary>
                            <div class="history-content">
                                <div class="log-list">`;
                dailyLogs.forEach(l => {
                     const isMyLog = State.user && l.author && l.author.uid === State.user.uid;
                     html += this.createLogEntryHTML(l, isMyLog);
                });
                html += `</div></div></details>`;
                return html;
            },

            showToast(msg) {
                const t = document.createElement('div'); t.className = 'toast'; t.innerText = msg;
                document.body.appendChild(t); setTimeout(()=>t.classList.add('show'),10);
                setTimeout(()=>{ t.classList.remove('show'); setTimeout(()=>t.remove(),400); },3000);
            },
            async showConfirmModal(msg) {
                return new Promise(res => {
                    const m = document.getElementById('custom-confirm-modal');
                    if(!m) return res(false);
                    document.getElementById('confirm-message').innerText = msg;
                    m.classList.add('active');
                    const okBtn = document.getElementById('confirm-ok-btn');
                    const cancelBtn = document.getElementById('confirm-cancel-btn');
                    
                    const newOkBtn = okBtn.cloneNode(true);
                    const newCancelBtn = cancelBtn.cloneNode(true);
                    okBtn.parentNode.replaceChild(newOkBtn, okBtn);
                    cancelBtn.parentNode.replaceChild(newCancelBtn, cancelBtn);

                    newOkBtn.onclick = () => { m.classList.remove('active'); res(true); };
                    newCancelBtn.onclick = () => { m.classList.remove('active'); res(false); };
                });
            }
        };

        // Explicitly attach UIManager to window
        window.UIManager = UIManager;
        
        window.onload = async () => {
            UIManager.init();
            
            document.getElementById('auth-btn').onclick = window.handleAuthClick;

            let unsubscribeLogs = null;
            let unsubscribeShared = null;
            
            const configRef = doc(db, 'config', 'schedules');
            onSnapshot(configRef, (doc) => {
                if (doc.exists()) {
                    State.specialSchedules = doc.data().special_programs || [];
                    if (State.input.tour) window.handleTourSelect(State.input.tour);
                }
            });

            onAuthStateChanged(auth, user => {
                State.user = user;
                const authBtn = document.getElementById('auth-btn');
                if (user) {
                    authBtn.innerHTML = `<img src="${user.photoURL}" class="auth-user-img" onerror="this.style.display='none'">`;
                    
                    const paths = getPaths(user.uid);
                    if (paths) {
                        unsubscribeLogs = onSnapshot(paths.logs, (snap) => {
                            State.logs = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                            if (!State.editingId) {
                                const nextState = Logic.calculateNextState(UIManager.els.date.value);
                                State.input.count = nextState.count;
                                State.input.suspendedTours = nextState.suspendedTours;
                            }
                            UIManager.updateAll(); 
                        });
                        const q = query(paths.shared, where("author.uid", "==", user.uid));
                        unsubscribeShared = onSnapshot(q, (snap) => {
                            State.publishedDates = new Set(snap.docs.map(d => d.data().date));
                            window.renderMainContent(); 
                        });
                    }
                } else {
                    authBtn.innerHTML = `<span class="material-symbols-outlined">account_circle</span>`;
                    State.logs = []; 
                    State.publishedDates = new Set();
                    UIManager.updateAll();
                }
            });
            
            document.getElementById('visit-date').onchange = () => UIManager.handleDateChange(true);
            document.getElementById('btn-count-plus').onclick = () => { State.input.count++; UIManager.updateAll(); };
            document.getElementById('btn-count-minus').onclick = () => { State.input.count = Math.max(1, State.input.count-1); UIManager.updateAll(); };
            document.getElementById('time-widget').onclick = () => UIManager.activateTimeInput();
            document.getElementById('visit-time').onclick = (e) => { e.stopPropagation(); if('showPicker' in HTMLInputElement.prototype) e.target.showPicker(); };
            document.querySelector('.time-clear-btn').onclick = (e) => { e.stopPropagation(); UIManager.deactivateTimeInput(); };
            document.getElementById('floor-1').onclick = () => { State.input.floor = State.input.floor === 1 ? null : 1; UIManager.updateAll(); };
            document.getElementById('floor-2').onclick = () => { State.input.floor = State.input.floor === 2 ? null : 2; UIManager.updateAll(); };
            ['A', 'B', 'C'].forEach(t => {
                document.getElementById(`tour-btn-${t}`).onclick = () => window.handleTourSelect(t);
                document.getElementById(`suspend-btn-${t}`).onclick = async () => {
                    const idx = State.input.suspendedTours.indexOf(t);
                    const isSuspended = idx > -1;
                    const confirmMsg = isSuspended 
                        ? `TOUR ${t} を「運営中」に変更しますか？` 
                        : `TOUR ${t} を「運営休止」に設定しますか？`;
                    
                    if (await UIManager.showConfirmModal(confirmMsg)) {
                        if (isSuspended) State.input.suspendedTours.splice(idx, 1); else State.input.suspendedTours.push(t);
                        UIManager.updateAll();
                    }
                };
            });
            ['std', 'l13', 'shadow', 'unknown'].forEach((id, idx) => {
                const pKeys = ['TOWER 1', 'TOWER 2', 'TOWER 3', 'UNKNOWN'];
                document.getElementById(`prof-${id}`).onclick = () => window.handleProfileSelect(pKeys[idx]);
            });
            document.getElementById('submit-btn').onclick = window.saveLog;
            
            UIManager.initSwipeTabNavigation();
            window.loadSharedReports();
        };
    </script>
</body>
</html>