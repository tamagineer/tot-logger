<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <!-- キャッシュ対策 -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">

    <title>TOT Logger</title>
    
    <!-- Google Fonts & Icons -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans:wght@400;700&family=Noto+Sans+JP:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
    <link rel="stylesheet" href="https://use.typekit.net/erb7jzd.css">

    <style>
        /* =========================================
           1. BASE
           ========================================= */
        :root {
            --c-bg: #000000;
            --c-card: #161616;
            --c-text: #e0e0e0;
            --c-text-sub: #888;
            --c-accent: #ffffff;
            --c-border: #333;
            --c-fab: #ffffff; /* FAB Color */
            --c-fab-text: #000000;
            --nav-height: 60px;
            --header-height: 56px;
        }

        body {
            background-color: var(--c-bg); color: var(--c-text);
            font-family: 'Noto Sans JP', sans-serif;
            margin: 0; padding: 0; width: 100%; height: 100%;
            -webkit-tap-highlight-color: transparent; overflow: hidden; /* App-like feel */
        }

        /* Scrollable Main Area */
        .app-container {
            height: 100vh; display: flex; flex-direction: column;
        }
        
        .main-content {
            flex: 1; overflow-y: auto; position: relative;
            padding-bottom: 80px; /* Space for FAB */
            scroll-behavior: smooth;
        }

        /* =========================================
           2. NAVIGATION & HEADER
           ========================================= */
        /* Top Header */
        .app-header {
            height: var(--header-height);
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 20px; border-bottom: 1px solid var(--c-border);
            background: rgba(0,0,0,0.8); backdrop-filter: blur(10px);
            position: sticky; top: 0; z-index: 100;
        }
        .app-title { font-family: "stencil-std", sans-serif; font-size: 1.5rem; letter-spacing: 1px; color: var(--c-accent); margin: 0; }
        
        .header-actions { display: flex; gap: 15px; align-items: center; }
        .user-icon-btn { width: 32px; height: 32px; border-radius: 50%; border: 1px solid #444; object-fit: cover; cursor: pointer; }
        
        /* Bottom Tabs */
        .bottom-nav {
            height: var(--nav-height); border-top: 1px solid var(--c-border);
            background: #080808; display: flex; justify-content: space-around; align-items: center;
            padding-bottom: env(safe-area-inset-bottom);
            position: relative; z-index: 100;
        }
        .nav-item {
            flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center;
            background: none; border: none; color: #555; cursor: pointer; height: 100%;
            transition: color 0.2s;
        }
        .nav-item.active { color: #fff; }
        .nav-item .material-symbols-outlined { font-size: 1.6rem; margin-bottom: 3px; }
        .nav-label { font-size: 0.65rem; font-weight: bold; }
        .nav-item.active .material-symbols-outlined { font-variation-settings: 'FILL' 1; }

        /* FAB (Floating Action Button) */
        .fab {
            position: fixed; bottom: calc(var(--nav-height) + 20px); right: 20px;
            width: 56px; height: 56px; border-radius: 50%;
            background: var(--c-fab); color: var(--c-fab-text);
            border: none; box-shadow: 0 4px 12px rgba(255,255,255,0.3);
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; z-index: 200; transition: transform 0.1s;
        }
        .fab:active { transform: scale(0.95); }
        .fab .material-symbols-outlined { font-size: 2rem; }

        /* =========================================
           3. VIEWS (TABS)
           ========================================= */
        .view-section { display: none; padding: 20px; animation: fadeIn 0.2s ease; }
        .view-section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* History List Styles */
        .log-list-container { display: flex; flex-direction: column; gap: 15px; }
        
        details.log-group { 
            background: var(--c-card); border: 1px solid var(--c-border); 
            border-radius: 8px; overflow: hidden;
        }
        summary.log-summary {
            padding: 15px; display: flex; align-items: center; justify-content: space-between;
            cursor: pointer; list-style: none; font-weight: bold; background: #1a1a1a;
        }
        summary.log-summary::-webkit-details-marker { display: none; }
        .summary-left { display: flex; align-items: center; gap: 10px; }
        .arrow-icon { color: #666; transition: transform 0.2s; }
        details[open] .arrow-icon { transform: rotate(90deg); color: #fff; }
        
        .log-entry { 
            padding: 15px; border-top: 1px solid #333; 
            display: flex; align-items: center; justify-content: space-between;
        }
        .log-content { display: flex; flex-direction: column; gap: 4px; }
        .log-main-text { font-size: 1.1rem; font-weight: bold; color: #fff; display: flex; align-items: baseline; gap: 8px; }
        .log-sub-text { font-size: 0.8rem; color: #888; }
        .font-stencil { font-family: "stencil-std", sans-serif; letter-spacing: 1px; }

        /* Public Log Styles */
        .public-tabs { display: flex; margin-bottom: 15px; background: #222; border-radius: 8px; padding: 4px; }
        .p-tab { 
            flex: 1; background: none; border: none; color: #888; padding: 8px; 
            border-radius: 6px; font-weight: bold; font-size: 0.85rem; cursor: pointer;
        }
        .p-tab.active { background: #444; color: #fff; }
        .shared-list { min-height: 200px; }
        .status-table { width: 100%; border-collapse: collapse; text-align: center; font-size: 0.8rem; }
        .status-table th, .status-table td { border: 1px solid #444; padding: 8px 4px; }
        .status-table th { background: #222; color: #aaa; }

        /* =========================================
           4. RECORD MODAL (FULL SCREEN)
           ========================================= */
        .record-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 1000;
            display: flex; flex-direction: column;
            transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.25, 1, 0.5, 1);
        }
        .record-modal.open { transform: translateY(0); }

        .modal-header {
            height: var(--header-height); padding: 0 15px;
            display: flex; align-items: center; justify-content: space-between;
            border-bottom: 1px solid #333; background: #111;
            flex-shrink: 0;
        }
        .modal-title { font-weight: bold; font-size: 1rem; }
        .btn-text { background: none; border: none; color: #aaa; font-size: 0.9rem; padding: 10px; }
        .btn-action { 
            background: none; border: none; color: #fff; font-weight: bold; font-size: 0.9rem; padding: 8px 16px;
            background: #fff; color: #000; border-radius: 20px; opacity: 0.3; pointer-events: none; transition: 0.2s;
        }
        .btn-action.active { opacity: 1; pointer-events: auto; }

        .modal-body {
            flex: 1; overflow: hidden; position: relative; display: flex;
        }

        /* Step Slider */
        .step-container {
            width: 100%; height: 100%; padding: 20px; box-sizing: border-box;
            display: none; flex-direction: column; overflow-y: auto;
        }
        .step-container.active { display: flex; animation: slideIn 0.3s ease; }
        @keyframes slideIn { from { opacity: 0; transform: translateX(20px); } to { opacity: 1; transform: translateX(0); } }

        /* Step 1: Location Grid */
        .location-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; height: 100%; max-height: 400px; }
        .loc-col { display: flex; flex-direction: column; gap: 12px; }
        .loc-head { text-align: center; font-weight: bold; color: #666; font-size: 0.8rem; }
        .loc-btn {
            flex: 1; background: #222; border: 1px solid #444; border-radius: 8px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            color: #fff; cursor: pointer; transition: 0.1s;
        }
        .loc-btn:active { background: #444; }
        .tour-char { font-size: 2rem; font-weight: bold; }
        .floor-num { font-size: 0.9rem; color: #888; }

        /* Step 2: Vehicle Grid */
        .vehicle-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; height: 100%; max-height: 400px; }
        .veh-btn {
            background: #222; border: 1px solid #444; border-radius: 8px;
            display: flex; align-items: center; justify-content: center;
            color: #fff; font-family: "stencil-std", sans-serif; font-size: 2.5rem;
            cursor: pointer;
        }
        .veh-btn:active { background: #444; }
        .edit-icon { font-size: 1.5rem; color: #aaa; }

        /* Step 3: Confirm */
        .confirm-card {
            background: #1a1a1a; border: 1px solid #444; border-radius: 12px;
            padding: 25px; text-align: center; margin-bottom: 20px;
        }
        .confirm-main { font-size: 2.5rem; font-weight: bold; margin-bottom: 5px; }
        .confirm-sub { color: #888; font-size: 0.9rem; }
        
        .form-section { margin-bottom: 20px; }
        .section-label { display: block; color: #888; font-size: 0.8rem; margin-bottom: 8px; font-weight: bold; }
        .profile-badges { display: flex; gap: 10px; overflow-x: auto; padding-bottom: 5px; }
        .p-badge { 
            background: #222; border: 1px solid #444; color: #aaa; padding: 8px 12px; 
            border-radius: 20px; font-size: 0.85rem; white-space: nowrap; cursor: pointer;
        }
        .p-badge.selected { background: #fff; color: #000; border-color: #fff; }
        .memo-input { 
            width: 100%; background: #222; border: 1px solid #444; color: #fff; 
            padding: 10px; border-radius: 6px; box-sizing: border-box; 
        }

        /* Utility */
        .step-indicator {
            position: absolute; bottom: 20px; left: 0; width: 100%;
            display: flex; justify-content: center; gap: 8px; pointer-events: none;
        }
        .dot { width: 8px; height: 8px; border-radius: 50%; background: #333; transition: 0.3s; }
        .dot.active { background: #fff; transform: scale(1.2); }

        /* Toast */
        .toast {
            position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%) translateY(20px);
            background: #333; color: #fff; padding: 10px 20px; border-radius: 30px;
            font-size: 0.9rem; opacity: 0; transition: 0.3s; pointer-events: none; z-index: 2000;
        }
        .toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }
        
        /* Auth Modal */
        #auth-overlay {
            position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9);
            z-index: 3000; display:none; align-items:center; justify-content:center;
        }
        .auth-box { text-align:center; }
    </style>
</head>
<body>

    <div class="app-container">
        <!-- HEADER -->
        <header class="app-header">
            <h1 class="app-title">TOT LOGGER</h1>
            <div class="header-actions">
                <div id="user-display" style="display:none;">
                    <img id="header-user-icon" class="user-icon-btn">
                </div>
                <button id="header-login-btn" class="btn-text" style="color:#fff; font-size:0.8rem; border:1px solid #444; border-radius:15px;">LOGIN</button>
            </div>
        </header>

        <!-- MAIN CONTENT AREA -->
        <main class="main-content">
            
            <!-- VIEW: MY LOG (Default) -->
            <div id="view-history" class="view-section active">
                <div id="history-loading" style="text-align:center; padding:20px; color:#666;">読み込み中...</div>
                <div id="history-list" class="log-list-container"></div>
                <!-- 空の状態 -->
                <div id="history-empty" style="display:none; text-align:center; padding:40px; color:#666;">
                    <span class="material-symbols-outlined" style="font-size:3rem; margin-bottom:10px;">history_edu</span>
                    <p>まだ記録がありません。<br>右下の＋ボタンから記録しましょう。</p>
                </div>
            </div>

            <!-- VIEW: PUBLIC LOG -->
            <div id="view-public" class="view-section">
                <div class="public-tabs">
                    <button class="p-tab active" data-tab="status">運営状況</button>
                    <button class="p-tab" data-tab="logs">みんなのログ</button>
                </div>
                <div id="public-content">
                    <p style="text-align:center; color:#666; margin-top:20px;">読み込み中...</p>
                </div>
            </div>

        </main>

        <!-- BOTTOM NAV -->
        <nav class="bottom-nav">
            <button class="nav-item active" data-target="view-history">
                <span class="material-symbols-outlined">account_circle</span>
                <span class="nav-label">マイログ</span>
            </button>
            <button class="nav-item" data-target="view-public">
                <span class="material-symbols-outlined">public</span>
                <span class="nav-label">みんなのログ</span>
            </button>
        </nav>

        <!-- FAB -->
        <button id="fab-record" class="fab">
            <span class="material-symbols-outlined">add</span>
        </button>
    </div>

    <!-- RECORD MODAL (Overlay) -->
    <div id="record-modal" class="record-modal">
        <header class="modal-header">
            <button id="modal-close-btn" class="btn-text">
                <span class="material-symbols-outlined">close</span>
            </button>
            <span class="modal-title">New Record</span>
            <button id="modal-save-btn" class="btn-action">記録する</button>
        </header>

        <div class="modal-body">
            
            <!-- STEP 1: Location -->
            <div id="step-1" class="step-container active">
                <div style="text-align:center; margin-bottom:15px; color:#888;">ツアーとフロアを選択</div>
                <div class="location-grid">
                    <!-- A -->
                    <div class="loc-col">
                        <div class="loc-head">A</div>
                        <button class="loc-btn" data-tour="A" data-floor="2"><span class="tour-char">A</span><span class="floor-num">2F</span></button>
                        <button class="loc-btn" data-tour="A" data-floor="1"><span class="tour-char">A</span><span class="floor-num">1F</span></button>
                    </div>
                    <!-- B -->
                    <div class="loc-col">
                        <div class="loc-head">B</div>
                        <button class="loc-btn" data-tour="B" data-floor="2"><span class="tour-char">B</span><span class="floor-num">2F</span></button>
                        <button class="loc-btn" data-tour="B" data-floor="1"><span class="tour-char">B</span><span class="floor-num">1F</span></button>
                    </div>
                    <!-- C -->
                    <div class="loc-col">
                        <div class="loc-head">C</div>
                        <button class="loc-btn" data-tour="C" data-floor="2"><span class="tour-char">C</span><span class="floor-num">2F</span></button>
                        <button class="loc-btn" data-tour="C" data-floor="1"><span class="tour-char">C</span><span class="floor-num">1F</span></button>
                    </div>
                </div>
            </div>

            <!-- STEP 2: Vehicle -->
            <div id="step-2" class="step-container">
                <div style="display:flex; justify-content:space-between; margin-bottom:15px; align-items:center;">
                    <button class="btn-text step-back" data-to="step-1"><span class="material-symbols-outlined">arrow_back</span> 戻る</button>
                    <span style="color:#888;">機体番号を選択</span>
                    <div style="width:60px;"></div>
                </div>
                <div class="vehicle-grid" id="veh-grid">
                    <!-- JS Generated -->
                </div>
            </div>

            <!-- STEP 3: Confirm -->
            <div id="step-3" class="step-container">
                <div style="display:flex; justify-content:space-between; margin-bottom:15px; align-items:center;">
                    <button class="btn-text step-back" data-to="step-2"><span class="material-symbols-outlined">arrow_back</span> 戻る</button>
                    <span style="color:#888;">内容確認</span>
                    <div style="width:60px;"></div>
                </div>
                
                <div class="confirm-card">
                    <div class="confirm-main">
                        <span id="disp-tour">A</span>-<span id="disp-floor">1</span>
                        <span style="color:#444; margin:0 5px;">/</span>
                        <span class="font-stencil">No.<span id="disp-veh">1</span></span>
                    </div>
                    <div class="confirm-sub">
                        <span id="disp-date"></span> • <span id="disp-count"></span>回目
                    </div>
                </div>

                <div class="form-section">
                    <span class="section-label">落下プロファイル (自動判定)</span>
                    <div class="profile-badges">
                        <button class="p-badge" data-val="TOWER 1">通常版</button>
                        <button class="p-badge" data-val="TOWER 2">Level 13</button>
                        <button class="p-badge" data-val="TOWER 3">シャドウ</button>
                        <button class="p-badge" data-val="UNKNOWN">不明</button>
                    </div>
                </div>

                <div class="form-section">
                    <span class="section-label">メモ</span>
                    <input type="text" id="input-memo" class="memo-input" placeholder="ひとこと...">
                </div>
            </div>

            <div class="step-indicator">
                <div class="dot active" id="dot-1"></div>
                <div class="dot" id="dot-2"></div>
                <div class="dot" id="dot-3"></div>
            </div>
        </div>
    </div>

    <!-- TOAST -->
    <div id="toast" class="toast">
        <span class="material-symbols-outlined">check_circle</span>
        <span id="toast-msg">Saved</span>
    </div>

    <!-- SCRIPT -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
        import { getFirestore, collection, addDoc, updateDoc, deleteDoc, setDoc, getDocs, getDoc, doc, onSnapshot, query, orderBy, serverTimestamp, limit, where } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
        import { getAuth, signInWithPopup, signOut, TwitterAuthProvider, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

        // --- CONFIG & STATE ---
        const CONSTANTS = {
            PROFILES: { 'TOWER 1': '通常版', 'TOWER 2': 'Level 13', 'TOWER 3': 'シャドウ', 'UNKNOWN': '不明' }
        };
        const State = {
            user: null, logs: [], specialSchedules: [],
            input: { date: '', count: 1, tour: null, floor: null, vehicle: null, profile: 'TOWER 1', memo: '' },
            currentTab: 'view-history'
        };

        // --- FIREBASE SETUP ---
        const firebaseConfig = {
          apiKey: "AIzaSyD4OXJQwa2YWfxbGS--qqz9ddi0VNio0xg",
          authDomain: "tot-logger.firebaseapp.com",
          projectId: "tot-logger",
          storageBucket: "tot-logger.firebasestorage.app",
          messagingSenderId: "485860677602",
          appId: "1:485860677602:web:e11380515fd9f1805ecbbb"
        };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // --- UI LOGIC ---
        const UI = {
            init() {
                // Tab Switching
                document.querySelectorAll('.nav-item').forEach(btn => {
                    btn.addEventListener('click', () => {
                        this.switchTab(btn.dataset.target);
                    });
                });

                // FAB & Modal
                document.getElementById('fab-record').addEventListener('click', () => {
                    if(!State.user) { this.showToast('ログインが必要です', true); return; }
                    this.resetInput();
                    this.openModal();
                });
                document.getElementById('modal-close-btn').addEventListener('click', this.closeModal);
                
                // Auth
                document.getElementById('header-login-btn').addEventListener('click', this.login);
                document.getElementById('header-user-icon').addEventListener('click', () => {
                    if(confirm("サインアウトしますか？")) this.logout();
                });

                // Step 1: Location
                document.querySelectorAll('.loc-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        State.input.tour = btn.dataset.tour;
                        State.input.floor = parseInt(btn.dataset.floor);
                        this.goToStep(2);
                    });
                });

                // Step 2: Vehicle Generator
                const vGrid = document.getElementById('veh-grid');
                for(let i=1; i<=9; i++){
                    const b = document.createElement('button');
                    b.className = 'veh-btn';
                    b.innerText = i;
                    b.onclick = () => { State.input.vehicle = i; this.goToStep(3); };
                    vGrid.appendChild(b);
                }

                // Step 3: Back buttons
                document.querySelectorAll('.step-back').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const step = parseInt(btn.dataset.to.replace('step-', ''));
                        this.goToStep(step);
                    });
                });

                // Profile Select
                document.querySelectorAll('.p-badge').forEach(btn => {
                    btn.addEventListener('click', () => {
                        State.input.profile = btn.dataset.val;
                        this.updateProfileUI();
                    });
                });

                // Save
                document.getElementById('modal-save-btn').addEventListener('click', this.saveLog);

                // Public Tabs
                document.querySelectorAll('.p-tab').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        document.querySelectorAll('.p-tab').forEach(b => b.classList.remove('active'));
                        e.target.classList.add('active');
                        this.loadPublicLog(e.target.dataset.tab);
                    });
                });
            },

            switchTab(targetId) {
                document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
                document.getElementById(targetId).classList.add('active');
                document.querySelectorAll('.nav-item').forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.target === targetId);
                });
                if(targetId === 'view-public') this.loadPublicLog('status');
            },

            openModal() {
                document.getElementById('record-modal').classList.add('open');
                this.goToStep(1);
            },
            closeModal() {
                document.getElementById('record-modal').classList.remove('open');
            },

            goToStep(stepNum) {
                document.querySelectorAll('.step-container').forEach(el => el.classList.remove('active'));
                document.getElementById(`step-${stepNum}`).classList.add('active');
                
                // Indicators
                document.querySelectorAll('.dot').forEach((d, i) => {
                    d.classList.toggle('active', i+1 === stepNum);
                });

                // Prepare Step 3
                if (stepNum === 3) {
                    this.prepareConfirm();
                    document.getElementById('modal-save-btn').classList.add('active');
                } else {
                    document.getElementById('modal-save-btn').classList.remove('active');
                }
            },

            resetInput() {
                // Auto Date
                const d = new Date();
                const today = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
                State.input.date = today;
                
                // Calc Count
                const todaysLogs = State.logs.filter(l => l.date === today);
                State.input.count = todaysLogs.length > 0 ? Math.max(...todaysLogs.map(l=>l.count)) + 1 : 1;
                
                // Reset others
                State.input.tour = null;
                State.input.floor = null;
                State.input.vehicle = null;
                State.input.memo = '';
                
                // Auto Profile
                State.input.profile = this.getAutoProfile(today);
            },

            getAutoProfile(dateStr) {
                const schedules = State.specialSchedules || [];
                const matched = schedules.find(s => dateStr >= s.start && dateStr <= s.end);
                if (matched) {
                    if(matched.type === 'L13') return 'TOWER 2';
                    if(matched.type === 'SHADOW') return 'TOWER 3';
                }
                const m = new Date(dateStr).getMonth();
                if(m <= 2) return 'TOWER 2'; // Default Jan-Mar logic
                return 'TOWER 1';
            },

            prepareConfirm() {
                document.getElementById('disp-tour').innerText = State.input.tour;
                document.getElementById('disp-floor').innerText = State.input.floor;
                document.getElementById('disp-veh').innerText = State.input.vehicle;
                document.getElementById('disp-date').innerText = State.input.date;
                document.getElementById('disp-count').innerText = State.input.count;
                document.getElementById('input-memo').value = State.input.memo;
                this.updateProfileUI();
            },

            updateProfileUI() {
                document.querySelectorAll('.p-badge').forEach(btn => {
                    btn.classList.toggle('selected', btn.dataset.val === State.input.profile);
                });
            },

            async saveLog() {
                if(!State.user) return;
                const btn = document.getElementById('modal-save-btn');
                btn.innerText = "保存中...";
                
                try {
                    const d = new Date();
                    const timeStr = `${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
                    
                    const data = {
                        date: State.input.date,
                        time: timeStr,
                        count: State.input.count,
                        tour: State.input.tour,
                        floor: State.input.floor,
                        vehicle: State.input.vehicle,
                        profile: State.input.profile,
                        memo: document.getElementById('input-memo').value,
                        author: { uid: State.user.uid, name: State.user.displayName, photoURL: State.user.photoURL },
                        createdAt: serverTimestamp()
                    };

                    await addDoc(collection(db, "logs"), data);
                    
                    // Share to Public (Simplified: Auto update shared doc)
                    await UI.updatePublicDoc(data.date);

                    UI.showToast("記録しました");
                    UI.closeModal();

                } catch(e) {
                    console.error(e);
                    UI.showToast("エラーが発生しました", true);
                } finally {
                    btn.innerText = "記録する";
                }
            },

            // シンプルな共有ロジック: その日の自分のログをまとめて1つのPublicドキュメントにする
            async updatePublicDoc(dateStr) {
                // Fetch all my logs for this date
                const q = query(collection(db, "logs"), where("author.uid", "==", State.user.uid), where("date", "==", dateStr));
                const snap = await getDocs(q);
                const logs = snap.docs.map(d => d.data());
                
                const summary = { A:{}, B:{}, C:{} };
                logs.forEach(l => {
                    if(l.tour && l.floor && l.vehicle) summary[l.tour][l.floor] = l.vehicle;
                });

                const publicId = `${dateStr}_${State.user.uid}`;
                await setDoc(doc(db, "shared_reports", publicId), {
                    date: dateStr,
                    author: { uid: State.user.uid, name: State.user.displayName, photoURL: State.user.photoURL },
                    summary: summary,
                    logs: logs.map(l => ({time: l.time, tour: l.tour, floor: l.floor, vehicle: l.vehicle, profile: l.profile})),
                    updatedAt: serverTimestamp()
                });
            },

            async login() {
                try { await signInWithPopup(auth, new TwitterAuthProvider()); } catch(e){ console.error(e); }
            },
            async logout() {
                await signOut(auth);
            },

            showToast(msg, isError=false) {
                const t = document.getElementById('toast');
                document.getElementById('toast-msg').innerText = msg;
                t.style.borderColor = isError ? '#f55' : '#4CAF50';
                t.classList.add('show');
                setTimeout(() => t.classList.remove('show'), 3000);
            },
            
            // --- RENDERERS ---
            renderHistory() {
                const container = document.getElementById('history-list');
                const loading = document.getElementById('history-loading');
                const empty = document.getElementById('history-empty');
                
                loading.style.display = 'none';
                container.innerHTML = '';
                
                if (State.logs.length === 0) {
                    empty.style.display = 'block';
                    return;
                }
                empty.style.display = 'none';

                // Group by Date
                const groups = {};
                State.logs.forEach(l => {
                    if(!groups[l.date]) groups[l.date] = [];
                    groups[l.date].push(l);
                });

                Object.keys(groups).sort((a,b)=>b.localeCompare(a)).forEach(date => {
                    const logs = groups[date];
                    const openAttr = (date === State.input.date) ? 'open' : ''; // Open today
                    
                    let html = `<details class="log-group" ${openAttr}>
                        <summary class="log-summary">
                            <div class="summary-left">
                                <span class="material-symbols-outlined arrow-icon">chevron_right</span>
                                <span>${date}</span>
                            </div>
                            <span style="color:#888; font-size:0.9rem;">${logs.length}件</span>
                        </summary>
                        <div class="log-items">`;
                    
                    logs.sort((a,b) => b.count - a.count).forEach(l => {
                         html += `<div class="log-entry">
                            <div class="log-content">
                                <div class="log-main-text">
                                    <span style="color:#aaa;">#${l.count}</span>
                                    <span>${l.tour}-${l.floor}</span>
                                    <span class="font-stencil">No.${l.vehicle}</span>
                                </div>
                                <div class="log-sub-text">${l.time} • ${CONSTANTS.PROFILES[l.profile]}</div>
                                ${l.memo ? `<div style="font-size:0.8rem; color:#666;">${l.memo}</div>` : ''}
                            </div>
                         </div>`;
                    });
                    
                    html += `</div></details>`;
                    container.innerHTML += html;
                });
            },

            async loadPublicLog(mode) {
                const container = document.getElementById('public-content');
                container.innerHTML = '<p style="text-align:center; padding:20px; color:#666;">読み込み中...</p>';
                
                try {
                    const q = query(collection(db, "shared_reports"), orderBy("date", "desc"), limit(20));
                    const snap = await getDocs(q);
                    const reports = snap.docs.map(d => d.data());
                    
                    if (reports.length === 0) { container.innerHTML = '<p style="text-align:center; padding:20px;">データなし</p>'; return; }

                    if (mode === 'status') {
                        let html = `<div style="overflow-x:auto;"><table class="status-table"><thead><tr><th>日付</th><th>A</th><th>B</th><th>C</th><th>User</th></tr></thead><tbody>`;
                        reports.forEach(r => {
                            const s = r.summary || {A:{}, B:{}, C:{}};
                            const cell = (t) => {
                                const f1 = s[t]?.[1] || '-';
                                const f2 = s[t]?.[2] || '-';
                                return `${f1} / ${f2}`;
                            };
                            html += `<tr><td>${r.date.slice(5)}</td><td>${cell('A')}</td><td>${cell('B')}</td><td>${cell('C')}</td><td><img src="${r.author.photoURL}" style="width:20px; border-radius:50%;"></td></tr>`;
                        });
                        html += '</tbody></table></div>';
                        container.innerHTML = html;
                    } else {
                        // Logs Mode
                        let html = '<div style="padding:10px;">';
                        reports.forEach(r => {
                            html += `<div style="margin-bottom:15px;">
                                <div style="font-weight:bold; border-bottom:1px solid #333; margin-bottom:5px;">${r.date} by ${r.author.name}</div>`;
                            (r.logs || []).forEach(l => {
                                html += `<div style="display:flex; justify-content:space-between; font-size:0.9rem; padding:4px 0; color:#ccc;">
                                    <span>${l.time}</span>
                                    <span>${l.tour}-${l.floor} <span class="font-stencil">No.${l.vehicle}</span></span>
                                </div>`;
                            });
                            html += `</div>`;
                        });
                        html += '</div>';
                        container.innerHTML = html;
                    }

                } catch(e) {
                    console.error(e);
                    container.innerHTML = '<p style="color:#f55; text-align:center;">エラー</p>';
                }
            }
        };

        // --- AUTH LISTENER ---
        onAuthStateChanged(auth, (user) => {
            if(user) {
                State.user = user;
                document.getElementById('header-login-btn').style.display = 'none';
                document.getElementById('user-display').style.display = 'block';
                document.getElementById('header-user-icon').src = user.photoURL;
                
                // Load Logs
                onSnapshot(query(collection(db, "logs"), where("author.uid", "==", user.uid), orderBy("date", "desc"), orderBy("createdAt", "desc")), (snap) => {
                    State.logs = snap.docs.map(d => d.data());
                    UI.renderHistory();
                });
            } else {
                State.user = null;
                document.getElementById('header-login-btn').style.display = 'block';
                document.getElementById('user-display').style.display = 'none';
                document.getElementById('history-list').innerHTML = '';
                document.getElementById('history-empty').style.display = 'block';
                document.getElementById('history-loading').style.display = 'none';
            }
        });

        // --- INIT ---
        document.addEventListener('DOMContentLoaded', async () => {
            // Config load
            try {
                const docRef = doc(db, "config", "schedules");
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) State.specialSchedules = docSnap.data().special_programs;
            } catch(e) {}
            
            UI.init();
        });

    </script>
</body>
</html>