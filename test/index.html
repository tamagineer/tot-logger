<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- キャッシュ対策 -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">

    <title>TOT Logger (Live Server)</title>
    
    <!-- Fonts & Icons -->
    <link rel="stylesheet" href="https://use.typekit.net/erb7jzd.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />

    <style>
        /* =========================================
           1. VARIABLES & BASE
           ========================================= */
        :root {
            --c-bg-body: #000000;
            --c-bg-card: #111111;
            --c-bg-input: #1a1a1a;
            --c-bg-btn: #000000;
            --c-bg-btn-active: #ffffff;
            --c-text-main: #e0e0e0;
            --c-text-sub: #888888;
            --c-text-inverse: #000000;
            --c-text-accent: #ffffff;
            --c-border: #333333;
            --c-border-light: #444444;
            --c-caution: #ff5555;
            --c-caution-bg: #221111;
            
            --radius-sm: 6px;
            --radius-md: 12px;
            --radius-pill: 24px;
            
            --font-main: 'Noto Sans JP', sans-serif;
            --font-display: "stencil-std", sans-serif;
            
            /* Spacing System */
            --space-xs: 8px;
            --space-sm: 16px;
            --space-md: 24px;
            --space-lg: 40px;
            --space-xl: 60px;
        }

        body {
            background-color: var(--c-bg-body); color: var(--c-text-main); font-family: var(--font-main);
            margin: 0; padding: 0; text-align: center; box-sizing: border-box; width: 100%; font-weight: 400;
            line-height: 1.5;
        }
        .main-wrapper { max-width: 600px; margin: 0 auto; padding: 20px; box-sizing: border-box; }

        body.modal-open { overflow: hidden; }

        /* 修正モード中の表示制御 */
        body.editing-mode .data-manager { display: none; }
        body.editing-mode .data-manager-separator { display: none; }

        header { padding: 10px 0 20px; }
        h1 {
            font-family: var(--font-display); font-size: 2.2rem; margin: 0 0 var(--space-md) 0;
            color: var(--c-text-accent); letter-spacing: 2px; border-bottom: 1px solid var(--c-border); padding-bottom: 20px;
        }

        /* =========================================
           2. 共通コンポーネント
           ========================================= */
        .label {
            font-size: 0.85rem; color: #bbb; margin-bottom: 8px; text-align: left; padding: 0; /* 左端揃え */ font-weight: bold;
            display: flex; justify-content: space-between; align-items: baseline;
            width: 100%; box-sizing: border-box;
            transition: color 0.3s;
        }
        .label-left { display: flex; align-items: center; }
        .label-right { font-size: 0.7rem; color: var(--c-text-sub); font-weight: normal; letter-spacing: 0.5px; }

        .btn {
            background-color: var(--c-bg-btn); color: #ccc; border: 1px solid var(--c-border-light);
            border-radius: var(--radius-sm); padding: 14px 0; font-size: 1rem;
            font-weight: 700; cursor: pointer; transition: all 0.15s ease; width: 100%; font-family: var(--font-main);
        }
        .btn:active { transform: scale(0.98); }
        .btn:hover { background-color: #222; color: #fff; border-color: #666; }
        .btn.selected { background-color: var(--c-bg-btn-active); color: var(--c-text-inverse); border-color: var(--c-bg-btn-active); }
        .btn.selected:hover { background-color: #e0e0e0; }

        .btn.loading { opacity: 0.6; pointer-events: none; cursor: wait; }
        
        /* 非推奨・注意・使用済み・休止ボタンのデザイン統一（破線・グレー） */
        .btn-caution, .btn-suspended-view, .btn-used { 
            border-style: dashed !important; 
            border-color: #444 !important; 
            color: #666 !important; 
        }
        .btn-caution:hover, .btn-suspended-view:hover, .btn-used:hover {
            color: #888 !important;
            border-color: #666 !important;
        }
        .btn-caution.selected, .btn-suspended-view.selected, .btn-used.selected { 
            background-color: #ccc !important; 
            color: #000 !important; 
            border-style: solid !important; 
            border-color: #ccc !important;
            opacity: 1;
        }

        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; }
        
        .config-section, .input-section { margin-bottom: var(--space-lg); }
        .data-manager { margin-bottom: var(--space-lg); }
        .data-manager-separator { border-top: 1px dashed #333; padding-top: var(--space-lg); }
        
        .input-block { 
            margin-bottom: var(--space-md); 
            border-radius: var(--radius-sm); 
            transition: all 0.3s;
        }
        
        .error-icon {
            display: none;
            color: var(--c-caution);
            font-size: 1.2rem;
            margin-left: 8px;
            vertical-align: middle; 
        }
        
        .input-missing .error-icon {
            display: inline-block;
        }

        /* =========================================
           3. ユーザー設定・日付エリア
           ========================================= */
        .user-settings-area {
            padding: 0; margin-bottom: var(--space-md);
            background: transparent; border: none;
            height: auto; min-height: 60px; display: flex; align-items: center; justify-content: center; box-sizing: border-box;
        }
        .user-settings-area.logged-in { justify-content: space-between; padding: 0 4px; }
        #login-container { width: 100%; }
        .sign-in-btn { display: flex; align-items: center; justify-content: center; gap: 8px; padding: 12px 0; }
        #user-info { display: flex; justify-content: space-between; align-items: center; width: 100%; }
        .user-info-left { display: flex; align-items: center; gap: 12px; }
        .user-icon-img { width: 40px; height: 40px; border-radius: 50%; border: 1px solid #555; object-fit: cover; }
        .user-text { text-align: left; line-height: 1.2; }
        #user-name { font-weight: bold; font-size: 0.95rem; color: #fff; }
        #user-screen-name { font-size: 0.75rem; color: #888; }
        .logout-icon-btn {
            background: transparent; border: none; color: #666;
            width: 40px; height: 40px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; transition: all 0.2s;
        }
        .logout-icon-btn:hover { background: rgba(255,255,255,0.1); color: #fff; }

        .date-counter-area { 
            background: var(--c-bg-card); padding: 20px; 
            border-radius: var(--radius-md); border: 1px solid var(--c-border); 
            margin-bottom: var(--space-lg); 
            display: flex; flex-direction: column; gap: 15px;
        }
        .date-row { text-align: center; }
        .date-row input[type="date"] { 
            width: 100%; max-width: 100%; box-sizing: border-box;
            background: #000; color: #fff; border: 1px solid #444; 
            border-radius: var(--radius-sm); font-size: 1.1rem; font-weight: bold; 
            text-align: center; padding: 12px; color-scheme: dark; font-family: var(--font-main); 
        }

        .counter-ui { display: flex; align-items: center; justify-content: center; gap: 20px; }
        .counter-btn { 
            width: 48px; height: 48px; border-radius: 50%; 
            background: var(--c-bg-input); color: #fff; border: 1px solid #444; 
            font-size: 1.4rem; cursor: pointer; transition: 0.2s; 
            display: flex; align-items: center; justify-content: center;
        }
        .counter-btn:hover { background: #333; border-color: #888; }
        .counter-display { font-size: 2rem; font-weight: 700; min-width: 80px; color: #fff; }
        .unit { font-size: 0.9rem; color: #888; font-weight: normal; margin-left: 4px; }

        .time-section-fixed { display: flex; justify-content: center; align-items: center; height: 40px; }
        .time-widget {
            position: relative; background: #0a0a0a; border: 1px solid #444; border-radius: 20px;
            height: 34px; width: 130px; display: flex; align-items: center; justify-content: center;
            cursor: pointer; overflow: hidden; transition: all 0.3s cubic-bezier(0.25, 1, 0.5, 1); color: #888;
        }
        .time-widget:hover { background: #222; border-color: #666; color: #fff; }
        .time-widget.active { width: 160px; background: #222; border-color: #fff; color: #fff; cursor: default; }
        .time-placeholder { display: flex; align-items: center; gap: 6px; font-size: 0.8rem; font-weight: bold; letter-spacing: 0.5px; white-space: nowrap; position: absolute; transition: opacity 0.2s; }
        .time-widget.active .time-placeholder { opacity: 0; pointer-events: none; }
        .time-editor { display: flex; align-items: center; gap: 5px; opacity: 0; pointer-events: none; transition: opacity 0.3s 0.1s; }
        .time-widget.active .time-editor { opacity: 1; pointer-events: auto; }
        .time-editor input[type="time"] { background: transparent; border: none; color: #fff; font-size: 1rem; font-family: var(--font-main); width: 90px; text-align: center; padding: 0; outline: none; }
        .time-editor input[type="time"]::-webkit-calendar-picker-indicator { display: none; -webkit-appearance: none; }
        .time-clear-btn { background: #444; border: none; color: #ccc; width: 22px; height: 22px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: 0.2s; flex-shrink: 0; }
        .time-clear-btn:hover { background: #666; color: #fff; }
        .time-clear-btn .material-symbols-outlined { font-size: 12px; }

        /* =========================================
           4. 入力エリア
           ========================================= */
        .status-bar-wrapper { margin-top: 15px; }
        .status-bar { border: 1px solid var(--c-border); background: var(--c-bg-card); padding: 10px; border-radius: var(--radius-sm); font-weight: bold; color: #fff; font-size: 0.95rem; }
        .vehicle-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; }
        .vehicle-btn { height: 56px; font-size: 1.3rem; display: flex; justify-content: center; align-items: center; }
        
        .profile-options { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        .profile-btn { font-size: 0.85rem; padding: 12px 0; line-height: 1.3; }
        
        .suspension-area { 
            border: 1px dashed var(--c-border); background: #0f0f0f;
            padding: 15px; border-radius: var(--radius-sm); margin-bottom: var(--space-md); 
        }
        .suspension-area .label { color: #888; }
        .suspend-btn-container { display: flex; justify-content: center; gap: 8px; }
        .suspend-btn { flex: 1; padding: 10px; background: #000; border: 1px solid #444; color: #666; border-radius: var(--radius-sm); font-size: 0.85rem; cursor: pointer; transition: 0.2s; }
        .suspend-btn.active { background: var(--c-caution-bg); border-color: var(--c-caution); color: var(--c-caution); font-weight: bold; }
        
        .memo-area { margin-bottom: var(--space-lg); }
        .memo-area textarea { width: 100%; height: 80px; padding: 12px; background: var(--c-bg-card); color: #fff; border: 1px solid #444; border-radius: var(--radius-sm); resize: none; font-size: 0.95rem; box-sizing: border-box; font-family: var(--font-main); line-height: 1.5; }
        .memo-area textarea:focus { border-color: #888; outline: none; }

        .submit-btn { width: 100%; padding: 18px; background: #222; color: #fff; border: 1px solid #fff; font-weight: bold; font-size: 1.1rem; cursor: pointer; border-radius: var(--radius-sm); display: flex; align-items: center; justify-content: center; gap: 8px; transition: 0.2s; }
        .cancel-btn { width: 100%; padding: 15px; margin-top: 15px; background: transparent; color: #888; border: 1px solid #444; border-radius: var(--radius-sm); cursor: pointer; font-size: 0.9rem; display: flex; align-items: center; justify-content: center; gap: 8px; transition: 0.2s; }

        /* =========================================
           5. 搭乗ログ & モーダル共通
           ========================================= */
        .main-accordion {
            background: #222;
            border: 1px solid #444;
            border-radius: var(--radius-sm);
            margin-bottom: 15px;
            overflow: visible; /* Sticky対応のためvisibleに変更 */
            transition: background 0.2s;
        }
        .main-accordion[open] { background: #1a1a1a; }
        
        .menu-trigger-summary {
            background: #222; padding: 16px 20px; 
            display: flex; justify-content: space-between; align-items: center; 
            cursor: pointer; list-style: none;
            border-radius: var(--radius-sm);
        }
        .main-accordion[open] > .menu-trigger-summary { 
            border-bottom-left-radius: 0;
            border-bottom-right-radius: 0;
        }

        .menu-trigger-summary::-webkit-details-marker { display: none; }
        .menu-trigger-summary:hover { background: #2a2a2a; }

        .menu-title-group { display: flex; align-items: center; gap: 12px; }
        .menu-title-ja { font-size: 1rem; font-weight: bold; color: #fff; }
        
        .arrow-icon { color: #888; transition: transform 0.3s; font-size: 1.4rem; }
        .main-accordion[open] > .menu-trigger-summary .arrow-icon { transform: rotate(180deg); color: #fff; }
        
        .history-content-wrapper {
            padding: 10px; /* 上下左右統一 */
            background: #111;
            border-top: 1px solid #333;
            /* 修正：日付別ブロックが1つある状態（未展開）と同じ高さに設定 */
            min-height: 56px; 
            display: flex;
            flex-direction: column;
            justify-content: center;
            border-bottom-left-radius: var(--radius-sm);
            border-bottom-right-radius: var(--radius-sm);
        }

        .menu-trigger-card { 
            background: #222; border: 1px solid #444; border-radius: var(--radius-sm); 
            padding: 16px 20px; display: flex; justify-content: space-between; align-items: center; 
            cursor: pointer; margin-bottom: 15px; transition: background 0.2s; 
        }
        .menu-trigger-card:hover { background: #2a2a2a; }
        
        details.daily-log { 
            background: var(--c-bg-card); 
            border: 1px solid var(--c-border); 
            border-radius: var(--radius-sm); 
            margin-bottom: 10px; 
            overflow: visible; 
            text-align: left; 
        }
        details.daily-log:last-child { margin-bottom: 0; }

        /* マイログの日付ヘッダーもStickyに */
        summary.daily-summary { 
            background: #1a1a1a; padding: 12px 15px; 
            cursor: pointer; font-weight: bold; 
            display: flex; align-items: center; color: #fff; 
            list-style: none; border-bottom: 1px solid #222; 
            justify-content: space-between;
            position: sticky; top: 0; z-index: 5; /* 追加 */
        }
        summary.daily-summary::-webkit-details-marker { display: none; }
        
        .summary-left { display: flex; align-items: center; gap: 10px; flex: 1; }
        .summary-left .material-symbols-outlined { transition: transform 0.3s; }
        details.daily-log[open] > summary.daily-summary .summary-left .material-symbols-outlined { transform: rotate(90deg); }

        .summary-info { text-align: left; }
        .summary-date { font-weight: bold; font-size: 1rem; }
        .summary-count { font-size: 0.85rem; color: #aaa; margin-left: 8px; }
        
        .summary-right { display: flex; align-items: center; gap: 8px; margin-left: auto; }
        
        .publish-status-text {
            font-size: 0.75rem; color: #666; font-weight: normal; transition: color 0.2s;
        }
        .publish-status-text.active { color: #fff; font-weight: bold; }

        .toggle-switch-sm { position: relative; display: inline-block; width: 44px; height: 24px; flex-shrink: 0; }
        .toggle-switch-sm input { opacity: 0; width: 0; height: 0; }
        .slider-sm { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #333; transition: .4s; border-radius: 24px; border: 1px solid #555; }
        .slider-sm:before { position: absolute; content: ""; height: 16px; width: 16px; left: 3px; bottom: 3px; background-color: #888; transition: .4s; border-radius: 50%; }
        input:checked + .slider-sm { background-color: #ddd; border-color: #fff; }
        input:checked + .slider-sm:before { transform: translateX(19px); background-color: #000; }
        
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.85); backdrop-filter: blur(5px); z-index: 1000; display: none; align-items: center; justify-content: center; opacity: 0; transition: opacity 0.3s; }
        .modal-overlay.active { display: flex; opacity: 1; }
        
        .modal-content { 
            background: #111; width: 95%; 
            max-width: 600px; 
            height: 90%; border-radius: 8px; border: 1px solid #333; 
            display: flex; flex-direction: column; box-shadow: 0 10px 30px rgba(0,0,0,0.5); 
        }
        
        .modal-header { padding: 15px 20px; border-bottom: 1px solid #333; display: flex; justify-content: space-between; align-items: center; }
        .modal-title-group { display: flex; align-items: center; gap: 10px; }
        .modal-header h2 { margin: 0; font-size: 1.2rem; color: #fff; font-family: var(--font-display); }
        .modal-header-actions { display: flex; gap: 10px; }
        
        .header-icon-btn {
            background: transparent; border: none; color: #888; width: 36px; height: 36px; border-radius: 50%;
            cursor: pointer; display: flex; align-items: center; justify-content: center; transition: background 0.2s;
        }
        .header-icon-btn:hover { background: rgba(255, 255, 255, 0.1); color: #fff; }

        .tab-group { display: flex; border-bottom: 1px solid #333; background: #1a1a1a; }
        .tab-btn { flex: 1; padding: 12px; background: transparent; border: none; color: #888; font-weight: bold; cursor: pointer; transition: 0.2s; border-bottom: 3px solid transparent; font-size: 0.9rem; }
        .tab-btn.active { color: #fff; border-bottom-color: #fff; background: #222; }
        /* 上パディングを0にして、子要素のマージンで調整することでStickyヘッダーを綺麗に表示 */
        .shared-list { flex: 1; overflow-y: auto; padding: 0 15px 15px 15px; }

        /* === 運営状況テーブル（共有DB用） === */
        /* テーブルヘッダーのSticky固定 */
        .status-scroll-wrapper { overflow-x: auto; -webkit-overflow-scrolling: touch; margin-bottom: 20px; border: 1px solid #333; border-radius: 4px; margin-top: 20px; /* リスト先頭マージン */ }
        .shared-status-table { width: 100%; border-collapse: collapse; min-width: 500px; font-size: 0.75rem; }
        .shared-status-table th, .shared-status-table td { border: 1px solid #333; padding: 6px; text-align: center; color: #eee; white-space: nowrap; }
        .shared-status-table th { 
            background: #222; color: #aaa; font-weight: bold; 
            position: sticky; top: 0; z-index: 10;
        }
        /* [修正] 固定列の対象をクラスで厳密に指定 */
        .shared-status-table th.fixed-col-date { z-index: 15; left: 0; }
        .shared-status-table td.fixed-col-date { position: sticky; left: 0; background: #151515; z-index: 2; font-weight: bold; color: #fff; border-right: 1px solid #444; }
        .shared-status-table td.td-suspended { color: #ff5555; font-weight: bold; }
        
        /* ユーザー名の表示一貫性 */
        .author-info-mini { display: flex; align-items: center; gap: 6px; justify-content: center; min-width: 100px; max-width: 120px; }
        .author-icon-mini { width: 22px; height: 22px; border-radius: 50%; border: 1px solid #444; flex-shrink: 0; object-fit: cover; }
        .author-name-mini { font-size: 0.75rem; color: #ccc; flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; text-align: left; }

        /* === 共有ログの日付見出し === */
        /* Sticky固定とマージン調整 */
        .shared-date-header { 
            font-size: 1.05rem; font-weight: bold; color: #fff; 
            margin: 20px 0 0 0; 
            padding: 10px 0 8px; /* パディング調整 */
            border-bottom: 1px solid #333; 
            text-align: left; 
            background-color: #111; /* Sticky時の背景色（透過防止） */
            position: sticky; top: 0; z-index: 5;
        }

        /* =========================================
           6. 確認モーダル & 入力モーダル
           ========================================= */
        .modal-content.confirm-modal-content {
            width: 85%; max-width: 360px; height: auto; min-height: auto;
            background: #1a1a1a; border: 1px solid #444; border-radius: 12px;
            padding: 24px 20px; box-shadow: 0 15px 40px rgba(0,0,0,0.7);
            align-items: center; text-align: center;
        }
        .confirm-body { margin-bottom: 24px; display: flex; flex-direction: column; align-items: center; gap: 15px; }
        .confirm-icon { font-size: 2.5rem; color: #ccc; }
        .confirm-text { font-size: 0.95rem; color: #eee; line-height: 1.6; white-space: pre-wrap; margin: 0; font-family: var(--font-main); }
        .confirm-actions { display: flex; gap: 12px; width: 100%; justify-content: center; }

        .btn-text {
            background: transparent; border: 1px solid #444; color: #aaa;
            padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: bold;
            transition: 0.2s; flex: 1; max-width: 120px; font-family: var(--font-main);
        }
        .btn-text:hover { background: #333; color: #fff; }
        .btn-primary {
            background: #e0e0e0; border: none; color: #000;
            padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: bold;
            transition: 0.2s; flex: 1; max-width: 120px; font-family: var(--font-main);
        }
        .btn-primary:hover { background: #fff; box-shadow: 0 0 10px rgba(255,255,255,0.3); }

        .modal-text-input { width: 200px; background: #222; border: 1px solid #555; color: #fff; padding: 10px; border-radius: 4px; font-size: 1.5rem; text-align: center; font-weight: bold; margin-top: 10px; outline: none; }
        .modal-text-input:focus { border-color: #fff; background: #333; }

        .toast {
            position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%) translateY(100px);
            background: rgba(30, 30, 30, 0.95); color: #fff; padding: 12px 24px; border-radius: 30px;
            border: 1px solid #555; font-size: 0.9rem; font-weight: bold; opacity: 0; transition: all 0.4s; z-index: 2000;
            display: flex; align-items: center; gap: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.5);
        }
        .toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }

        .log-entry { display: flex; flex-direction: column; border-bottom: 1px solid #222; padding: 12px 15px; gap: 6px; }
        
        /* 共有ログ用の行スタイル（パディングゼロ） */
        .log-entry.shared-log-entry { padding: 12px 0; }

        /* ログリストのスタイル統一 */
        .log-grid {
            display: grid;
            align-items: center; /* デフォルトは中央揃え */
            gap: 8px;
            width: 100%;
            padding: 4px 0; /* 上下の余白 */
        }
        
        .log-grid-my {
            grid-template-columns: 32px 60px 1fr auto; /* 回数, 時刻, 内容, アクション */
        }
        
        .log-grid-shared {
            grid-template-columns: 32px 32px 60px 1fr auto; /* アイコン, 回数, 時刻, 内容, アクション */
        }
        
        .log-time { 
            color: #666; font-size: 0.85rem; 
            text-align: left; 
            font-weight: bold;
            margin-top: 2px; /* 位置調整 */
        }
        
        .log-count { 
            color: #888; font-weight: 700; font-size: 1.05rem; 
            text-align: center; margin-right: 4px;
            line-height: 1.2;
        }
        
        /* 構造変更：縦並びに対応 */
        .log-content-wrapper {
            display: flex; flex-direction: column; /* 縦並び */
            align-items: flex-start; 
            gap: 2px;
            overflow: hidden; 
        }
        
        .log-main-line { display: flex; align-items: baseline; gap: 6px; white-space: nowrap; overflow: hidden; max-width: 100%; }
        
        .log-memo-line { 
            font-size: 0.75rem; color: #666; 
            white-space: pre-wrap; word-break: break-all; 
            line-height: 1.3; 
            margin-top: 2px;
        }

        .text-location { font-size: 1.05rem; font-weight: 700; color: #fff; }
        .text-vehicle { font-size: 1.05rem; font-weight: 700; color: #fff; }
        .log-separator, .log-label-no { color: #666; font-size: 0.85rem; font-weight: bold; }
        .text-profile { font-size: 0.75rem; color: #666; margin-left: 4px; } /* #666に変更 */

        .log-actions { 
            display: flex; gap: 4px; justify-content: flex-end; align-self: center; margin-top: 0; 
            position: relative; /* メニュー用 */
        }
        
        .author-icon-list {
            width: 28px; height: 28px; border-radius: 50%; 
            border: 1px solid #444; object-fit: cover;
            margin-top: 2px;
        }
        
        .icon-btn { 
            background: transparent; border: none; color: #666; 
            width: 32px; height: 32px;
            border-radius: 50%;
            cursor: pointer; display: flex; align-items: center; justify-content: center; 
            transition: all 0.2s; 
        }
        .icon-btn:hover { 
            background-color: rgba(255, 255, 255, 0.1);
            color: #fff; 
        }
        .icon-btn .material-symbols-outlined { font-size: 1.2rem; }

        .daily-summary-box { padding: 10px; border-bottom: 1px solid #333; background: #111; }
        .status-table { width: 100%; border-collapse: collapse; margin-top: 0; }
        .status-table th, .status-table td { border: 1px solid #444; padding: 8px; text-align: center; font-size: 0.85rem; color: #eee; }
        .status-table th { background: #222; color: #aaa; }
        .profile-badge-small { display: block; font-size: 0.65rem; color: #999; margin-top: 4px; }
        .th-profile-sub { display: block; font-size: 0.7rem; color: #888; font-weight: normal; margin-top: 2px; }

        /* Footer Styles */
        .app-footer { margin-top: 50px; padding: 20px 0; border-top: 1px solid #222; font-size: 0.75rem; color: #555; letter-spacing: 1px; }
        .footer-app-name { font-size: 1rem; font-weight: bold; color: #ccc; margin-bottom: 8px; font-family: var(--font-display); }
        .footer-version { font-size: 0.75rem; color: #666; margin-bottom: 4px; }
        .disclaimer { font-size: 0.7rem; color: #444; margin-top: 5px; }
        .app-footer a { color: #888; text-decoration: none; border-bottom: 1px dotted #666; transition: 0.2s; }
        .app-footer a:hover { color: #fff; border-bottom-style: solid; }

        /* --- レスポンシブ対応 --- */
        @media (max-width: 600px) {
            /* 運営状況：日付短縮、名前非表示 */
            .date-full { display: none; }
            .date-short { display: inline; }
            .author-name-mini { display: none; }
            
            /* ログリスト：アクションボタン切り替え */
            .log-actions.desktop-only { display: none !important; }
            .log-actions.mobile-only { display: flex !important; }
        }
        @media (min-width: 601px) {
            .date-full { display: inline; }
            .date-short { display: none; }
            .log-actions.desktop-only { display: flex !important; }
            .log-actions.mobile-only { display: none !important; }
        }

        /* モバイルアクションメニュー */
        .action-menu-container { position: relative; }
        .action-menu { 
            position: absolute; right: 0; top: 100%; 
            background: #222; border: 1px solid #444; 
            border-radius: 4px; z-index: 100; 
            display: none; flex-direction: column; min-width: 100px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.5);
        }
        .action-menu.show { display: flex; }
        .action-menu-item {
            background: transparent; border: none; color: #eee;
            padding: 12px 15px; text-align: left; cursor: pointer;
            font-size: 0.9rem; width: 100%;
            display: flex; align-items: center; gap: 8px;
        }
        .action-menu-item:hover { background: #333; }
        .action-menu-item .material-symbols-outlined { font-size: 1.1rem; }
        .action-menu-item.delete-item { color: #ff5555; }
        
        /* オーバーレイ（メニュー背景クリックで閉じる用） */
        .menu-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 99; display: none;
        }
        .menu-overlay.active { display: block; }

    </style>
</head>
<body>
    <div class="main-wrapper">
        <header>
            <h1>TOT LOGGER</h1>
        </header>

        <main class="app-container">
            <!-- ユーザー・日付設定セクション -->
            <section class="config-section">
                <div class="user-settings-area" id="user-card">
                    <div id="login-container">
                        <button id="login-btn" class="btn sign-in-btn">
                            <span class="material-symbols-outlined">login</span>
                            <span>サインイン</span>
                        </button>
                    </div>
                    <div id="user-info" style="display: none;">
                        <div class="user-info-left">
                            <img id="user-icon" src="" alt="User" class="user-icon-img">
                            <div class="user-text">
                                <div id="user-name"></div>
                                <div id="user-screen-name"></div>
                            </div>
                        </div>
                        <button id="logout-btn" class="logout-icon-btn">
                            <span class="material-symbols-outlined">logout</span>
                        </button>
                    </div>
                </div>

                <div class="date-counter-area">
                    <div class="date-row"><input type="date" id="visit-date"></div>
                    <div class="counter-ui">
                        <button class="counter-btn" id="btn-count-minus">−</button>
                        <div class="counter-display"><span id="count-val">1</span><span class="unit">回目</span></div>
                        <button class="counter-btn" id="btn-count-plus">＋</button>
                    </div>
                    <div class="time-section-fixed">
                        <div id="time-widget" class="time-widget">
                            <div class="time-placeholder"><span class="material-symbols-outlined">schedule</span> 時刻を追加</div>
                            <div class="time-editor" onclick="event.stopPropagation()">
                                <input type="time" id="visit-time">
                                <button class="time-clear-btn"><span class="material-symbols-outlined">close</span></button>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- 入力セクション -->
            <section class="input-section">
                <div id="block-floor" class="input-block">
                    <div class="label">
                        <div class="label-left">フロア <span class="error-icon material-symbols-outlined">error</span></div>
                        <span class="label-right">FLOOR</span>
                    </div>
                    <div class="grid-2">
                        <button class="btn floor-btn" id="floor-1" data-floor="1">1F</button>
                        <button class="btn floor-btn" id="floor-2" data-floor="2">2F</button>
                    </div>
                </div>

                <div id="block-tour" class="input-block">
                    <div class="label">
                        <div class="label-left">ツアー <span class="error-icon material-symbols-outlined">error</span></div>
                        <span class="label-right">TOUR</span>
                    </div>
                    <div class="grid-3">
                        <button id="tour-btn-A" class="btn tour-btn">A</button>
                        <button id="tour-btn-B" class="btn tour-btn">B</button>
                        <button id="tour-btn-C" class="btn tour-btn">C</button>
                    </div>
                    <div class="status-bar-wrapper">
                        <div class="status-bar"><span id="room-name">フロアを選択</span></div>
                    </div>
                </div>

                <div id="block-vehicle" class="input-block">
                    <div class="label">
                        <div class="label-left">機体番号 <span class="error-icon material-symbols-outlined">error</span></div>
                        <span class="label-right">VEHICLE NO.</span>
                    </div>
                    <div id="vehicle-container" class="vehicle-grid"></div>
                </div>

                <div id="block-profile" class="input-block">
                    <div class="label">
                        <div class="label-left">落下プロファイル <span class="error-icon material-symbols-outlined">error</span></div>
                        <span class="label-right">DROP PROFILE</span>
                    </div>
                    <div class="profile-options">
                        <button id="prof-std" class="btn profile-btn" data-profile="TOWER 1">通常版</button>
                        <button id="prof-l13" class="btn profile-btn" data-profile="TOWER 2">Level 13</button>
                        <button id="prof-shadow" class="btn profile-btn" data-profile="TOWER 3">シャドウ</button>
                        <button id="prof-unknown" class="btn profile-btn" data-profile="UNKNOWN">不明</button>
                    </div>
                </div>

                <div class="suspension-area">
                    <div class="label">
                        <div class="label-left">運営休止ツアー</div>
                        <span class="label-right">SUSPENDED</span>
                    </div>
                    <div class="suspend-btn-container">
                        <button id="suspend-btn-A" class="suspend-btn">A</button>
                        <button id="suspend-btn-B" class="suspend-btn">B</button>
                        <button id="suspend-btn-C" class="suspend-btn">C</button>
                    </div>
                </div>

                <div class="memo-area">
                    <div class="label">
                        <div class="label-left">メモ</div>
                        <span class="label-right">MEMO</span>
                    </div>
                    <textarea id="memo-input" placeholder="メモを入力..."></textarea>
                </div>

                <div class="action-area">
                    <button id="submit-btn" class="submit-btn">記録する</button>
                    <button id="cancel-btn" class="cancel-btn" style="display:none;">キャンセル</button>
                </div>
            </section>

            <!-- ログ管理セクション -->
            <div class="data-manager-separator"></div>
            <section class="data-manager">
                <details class="main-accordion" id="my-log-accordion">
                    <summary class="menu-trigger-summary">
                        <div class="menu-title-group">
                            <span class="material-symbols-outlined">person</span> 
                            <span class="menu-title-ja">マイログ</span>
                        </div>
                        <span id="history-arrow" class="material-symbols-outlined arrow-icon">expand_circle_down</span>
                    </summary>
                    <div class="history-content-wrapper">
                        <div id="history-log"></div>
                    </div>
                </details>
                
                <div class="menu-trigger-card shared-trigger">
                    <div class="menu-title-group"><span class="material-symbols-outlined">group</span> <span class="menu-title-ja">みんなのログ</span></div>
                    <span class="material-symbols-outlined arrow-icon">open_in_new</span>
                </div>
            </section>
        </main>

        <!-- メニュー閉じる用オーバーレイ -->
        <div id="menu-overlay" class="menu-overlay" onclick="window.closeAllMenus()"></div>

        <!-- モーダル群 -->
        <div id="shared-db-modal" class="modal-overlay">
            <div class="modal-content">
                <div class="modal-header">
                    <div class="modal-title-group">
                        <span class="material-symbols-outlined">group</span>
                        <h2>みんなのログ</h2>
                    </div>
                    <div class="modal-header-actions">
                        <button class="header-icon-btn refresh-btn"><span class="material-symbols-outlined">refresh</span></button>
                        <button class="header-icon-btn modal-close-btn"><span class="material-symbols-outlined">close</span></button>
                    </div>
                </div>
                <div class="tab-group">
                    <button class="tab-btn active" data-tab="logs">搭乗ログ</button>
                    <button class="tab-btn" data-tab="status">運営状況</button>
                </div>
                <div id="shared-content-area" class="shared-list"></div>
            </div>
        </div>

        <div id="custom-confirm-modal" class="modal-overlay" style="z-index: 2000;">
            <div class="modal-content confirm-modal-content">
                <div class="confirm-body">
                    <span class="material-symbols-outlined confirm-icon">help</span>
                    <p id="confirm-message" class="confirm-text"></p>
                </div>
                <div class="confirm-actions">
                    <button id="confirm-cancel-btn" class="btn-text">キャンセル</button>
                    <button id="confirm-ok-btn" class="btn-primary">OK</button>
                </div>
            </div>
        </div>

        <footer class="app-footer">
            <p class="footer-app-name">TOT LOGGER</p>
            <p class="footer-version">Ver.1.0</p>
            <p class="disclaimer">Created by <a href="https://x.com/tamagineer" target="_blank" rel="noopener">Tamas (@tamagineer)</a></p>
        </footer>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
        import { getFirestore, collection, addDoc, updateDoc, deleteDoc, setDoc, getDocs, getDoc, doc, onSnapshot, query, orderBy, serverTimestamp, where, limit } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
        import { getAuth, onAuthStateChanged, signInWithPopup, TwitterAuthProvider, signOut } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

        // ==========================================
        //  Firebase Configuration
        // ==========================================
        const firebaseConfig = {
          apiKey: "AIzaSyD4OXJQwa2YWfxbGS--qqz9ddi0VNio0xg",
          authDomain: "tot-logger.firebaseapp.com",
          projectId: "tot-logger",
          storageBucket: "tot-logger.firebasestorage.app",
          messagingSenderId: "485860677602",
          appId: "1:485860677602:web:e11380515fd9f1805ecbbb"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // Constants
        const CONSTANTS = {
            ROOMS: { 'A-1': '絵画', 'A-2': '古代の武器', 'B-1': '鎧', 'B-2': '建築工芸品', 'C-1': 'タペストリー', 'C-2': '仮面' },
            PROFILES: { 'TOWER 1': '通常版', 'TOWER 2': 'Level 13', 'TOWER 3': 'シャドウ', 'UNKNOWN': '不明' },
            MESSAGES: {
                loginRequired: "サインインが必要です",
                saveSuccess: "記録しました",
                updateSuccess: "修正しました",
                confirmDelete: "削除しますか？",
                confirmReset: "日付を変更しますか？（入力内容と推奨設定がリセットされます）",
                vehicle7Caution: "7号機は消失したと言われています。記録しますか？",
                vehicleEmptyCaution: "機体番号が未選択です。「不明」として記録しますか？",
                confirmEdit: "修正モードを開きますか？",
                confirmPublish: "この記録を「みんなのログ」に公開しますか？",
                confirmUnpublish: "非公開にしますか？",
                confirmLogout: "サインアウトしますか？",
                usedVehicleCaution: "この機体番号は本日すでに別の乗り場で記録されています。記録しますか？"
            }
        };

        // State
        const State = {
            user: null, logs: [], specialSchedules: [], publishedDates: new Set(), openHistoryDates: new Set(),
            input: { count: 1, floor: null, tour: null, vehicle: null, profile: null, suspendedTours: [], memo: '' },
            editingId: null, lastScrollPos: 0, isTimeInputVisible: false, scrollToId: null, sharedReports: [], 
            currentSharedTab: 'logs',
            lastSharedScrollPos: null,
            isEditingFromShared: false
        };

        // Logic
        const Logic = {
            // ローカル時間のYYYY-MM-DDを取得
            getTodayStr: () => {
                const d = new Date();
                const year = d.getFullYear();
                const month = ('0' + (d.getMonth() + 1)).slice(-2);
                const day = ('0' + d.getDate()).slice(-2);
                return `${year}-${month}-${day}`;
            },
            getCurrentTimeStr: () => new Date().toTimeString().slice(0, 5),
            getProgramType(dateStr) {
                if (!State.specialSchedules || State.specialSchedules.length === 0) return null;
                const target = State.specialSchedules.find(s => dateStr >= s.start && dateStr <= s.end);
                return target ? target.type : null;
            },
            calculateNextState(dateStr) {
                const dayLogs = State.logs.filter(l => l.date === dateStr);
                if (dayLogs.length === 0) return { count: 1, suspendedTours: [] };
                const maxLog = dayLogs.reduce((prev, curr) => (prev.count > curr.count) ? prev : curr);
                return { count: maxLog.count + 1, suspendedTours: maxLog.suspended || [] };
            },
            calculateDailyState(dateVal, excludeId = null) {
                const dayLogs = State.logs.filter(l => l.date === dateVal && l.id !== excludeId);
                const assignments = {};
                const suspendedSet = new Set();
                const shaftHistory = { A: null, B: null, C: null };
                const usedVehiclesInOtherPlaces = new Set(); 

                dayLogs.forEach(log => {
                    if (log.tour && log.floor && log.vehicle) {
                        assignments[`${log.tour}-${log.floor}`] = log.vehicle;
                    }
                    if (log.suspended) log.suspended.forEach(t => suspendedSet.add(t));
                    if (log.tour) suspendedSet.delete(log.tour);
                    if (log.tour && log.profile && log.profile !== 'UNKNOWN') shaftHistory[log.tour] = log.profile;
                });
                
                return { assignments, suspended: { A: suspendedSet.has('A'), B: suspendedSet.has('B'), C: suspendedSet.has('C') }, shaftHistory };
            },
            analyzeProfileStatus(dateStr, tour) {
                const daily = this.calculateDailyState(dateStr, State.editingId);
                
                if (daily.shaftHistory[tour]) {
                    const established = daily.shaftHistory[tour];
                    const allProfiles = Object.keys(CONSTANTS.PROFILES);
                    return { 
                        defaultProfile: established, 
                        cautionProfiles: allProfiles.filter(k => k !== established) 
                    };
                }

                const program = this.getProgramType(dateStr);
                
                if (program === 'L13') {
                    return { defaultProfile: 'TOWER 2', cautionProfiles: ['TOWER 1', 'TOWER 3', 'UNKNOWN'] };
                }
                
                if (program === 'SHADOW') {
                    return { defaultProfile: 'TOWER 3', cautionProfiles: ['TOWER 1', 'TOWER 2', 'UNKNOWN'] };
                }
                
                const month = parseInt(dateStr.split('-')[1], 10);
                const isSpring = (month >= 1 && month <= 4);
                
                if (program === 'UNLIMITED' || (!program && isSpring)) {
                    return { defaultProfile: 'UNKNOWN', cautionProfiles: [] };
                }
                
                return { defaultProfile: 'TOWER 1', cautionProfiles: ['TOWER 2', 'TOWER 3', 'UNKNOWN'] };
            }
        };

        // Helper Functions
        function formatDate(dateStr) {
            // YYYY-MM-DD -> MM/DD
            const parts = dateStr.split('-');
            return `<span class="date-full">${dateStr}</span><span class="date-short">${parts[1]}/${parts[2]}</span>`;
        }

        function generateDailySummaryHTML(logs, dateStr, externalSuspended = null) {
            const tourData = { A: {floors:{}, profiles:new Set()}, B: {floors:{}, profiles:new Set()}, C: {floors:{}, profiles:new Set()} };
            const suspended = { A: false, B: false, C: false };
            if (externalSuspended) externalSuspended.forEach(t => suspended[t] = true);
            
            logs.forEach(log => {
                if(!tourData[log.tour]) return;
                if (log.floor && log.vehicle) tourData[log.tour].floors[log.floor] = log.vehicle;
                if (log.suspended) log.suspended.forEach(t => suspended[t] = true);
                if (log.profile) tourData[log.tour].profiles.add(log.profile); 
            });

            const getCell = (tour, floor) => {
                if (suspended[tour]) return '<span style="color:#ff5555;">×</span>';
                const v = tourData[tour].floors[floor];
                return v ? `<span style="font-weight:bold;">${v}</span>` : '-';
            };

            const program = Logic.getProgramType(dateStr);
            const month = parseInt(dateStr.split('-')[1], 10);
            const isSpring = (month >= 1 && month <= 4);
            const showProfiles = (program === 'UNLIMITED' || (!program && isSpring));

            const getProfileDisplay = (tour) => {
                if (!showProfiles) return '';
                if (suspended[tour]) return '<br><span class="th-profile-sub">-</span>';
                
                const profiles = Array.from(tourData[tour].profiles);
                const visibleProfiles = profiles.filter(p => p !== 'UNKNOWN');
                
                if (visibleProfiles.length === 0 && profiles.includes('UNKNOWN')) {
                    visibleProfiles.push('UNKNOWN');
                }
                
                if (visibleProfiles.length === 0) return '<br><span class="th-profile-sub">-</span>';
                
                const displayNames = visibleProfiles.map(p => CONSTANTS.PROFILES[p] || p);
                return `<br><span class="th-profile-sub">${displayNames.join('・')}</span>`;
            };

            return `
            <div class="daily-summary-box">
                <table class="status-table">
                    <thead>
                        <tr>
                            <th class="row-header"></th>
                            <th>TOUR A${getProfileDisplay('A')}</th>
                            <th>TOUR B${getProfileDisplay('B')}</th>
                            <th>TOUR C${getProfileDisplay('C')}</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr><th class="row-header">2F</th><td>${getCell('A', 2)}</td><td>${getCell('B', 2)}</td><td>${getCell('C', 2)}</td></tr>
                        <tr><th class="row-header">1F</th><td>${getCell('A', 1)}</td><td>${getCell('B', 1)}</td><td>${getCell('C', 1)}</td></tr>
                    </tbody>
                </table>
            </div>`;
        }

        // Global functions for menu
        window.toggleMenu = (logId, event) => {
            event.stopPropagation();
            const menu = document.getElementById(`menu-${logId}`);
            const overlay = document.getElementById('menu-overlay');
            if (menu) {
                // 他のメニューを閉じる
                document.querySelectorAll('.action-menu.show').forEach(m => {
                    if (m.id !== `menu-${logId}`) m.classList.remove('show');
                });
                
                if (menu.classList.contains('show')) {
                    menu.classList.remove('show');
                    overlay.classList.remove('active');
                } else {
                    menu.classList.add('show');
                    overlay.classList.add('active');
                }
            }
        };

        window.closeAllMenus = () => {
            document.querySelectorAll('.action-menu.show').forEach(m => m.classList.remove('show'));
            document.getElementById('menu-overlay').classList.remove('active');
        };

        // UI Manager
        const UIManager = {
            els: {},
            init() {
                this.els = {
                    date: document.getElementById('visit-date'), time: document.getElementById('visit-time'), count: document.getElementById('count-val'),
                    roomName: document.getElementById('room-name'), memo: document.getElementById('memo-input'),
                    vehicleContainer: document.getElementById('vehicle-container'), historyContainer: document.getElementById('history-log'),
                    submitBtn: document.getElementById('submit-btn'), cancelBtn: document.getElementById('cancel-btn'),
                    sharedModal: document.getElementById('shared-db-modal'), sharedTabs: document.querySelectorAll('.tab-btn'), sharedContent: document.getElementById('shared-content-area')
                };
                this.els.date.value = Logic.getTodayStr();
                this.handleDateChange(false);
            },
            updateAll() {
                document.body.classList.toggle('editing-mode', !!State.editingId);
                this.updateRoomDisplay(); this.updateSelectionStyles(); this.updateVehicleGrid(); this.renderHistory();
                this.els.count.innerText = State.input.count; this.els.memo.value = State.input.memo;
                this.updateEditModeUI(); this.updateTimeUI();
            },
            updateTimeUI() {
                const w = document.getElementById('time-widget');
                State.isTimeInputVisible ? w.classList.add('active') : w.classList.remove('active');
            },
            activateTimeInput() {
                State.isTimeInputVisible = true;
                if (!this.els.time.value) this.els.time.value = Logic.getCurrentTimeStr();
                this.updateAll();
                setTimeout(() => { 
                    this.els.time.focus(); 
                    if('showPicker' in HTMLInputElement.prototype) {
                        try { this.els.time.showPicker(); } catch(e){}
                    }
                }, 100);
            },
            deactivateTimeInput() { State.isTimeInputVisible = false; this.els.time.value = ''; this.updateAll(); },
            async handleDateChange(showConfirm = true) {
                if (showConfirm && !await this.showConfirmModal(CONSTANTS.MESSAGES.confirmReset)) return;
                this.resetInput(true);
            },
            resetInput(clearSuspended = false) {
                const wasEditing = !!State.editingId;
                const returnToShared = State.isEditingFromShared; // フラグを保持しておく
                const scrollPos = State.lastSharedScrollPos;

                State.editingId = null;
                const dateVal = this.els.date.value;
                const nextState = Logic.calculateNextState(dateVal);
                State.input = { count: nextState.count, floor: null, tour: null, vehicle: null, profile: null, suspendedTours: clearSuspended ? [] : nextState.suspendedTours, memo: '' };
                this.deactivateTimeInput(); this.updateAll();
                ['block-floor', 'block-tour', 'block-vehicle', 'block-profile'].forEach(id => {
                    const el = document.getElementById(id);
                    if(el) el.classList.remove('input-missing');
                });

                // 修正モードを抜けたら元の位置へ戻る
                if (wasEditing) {
                    setTimeout(() => window.scrollTo({ top: State.lastScrollPos, behavior: 'smooth' }), 100);
                    if (returnToShared) {
                         setTimeout(async () => {
                             await UIManager.openSharedModal();
                             const sharedList = document.getElementById('shared-content-area');
                             if(sharedList) sharedList.scrollTop = scrollPos;
                         }, 300);
                    }
                }
                
                State.isEditingFromShared = false;
                State.lastSharedScrollPos = null;
            },
            async openSharedModal() { 
                history.pushState({ modal: 'shared' }, '', ''); 
                State.currentSharedTab = 'logs';
                document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.toggle('active', btn.dataset.tab === 'logs'));
                this.els.sharedModal.classList.add('active'); 
                document.body.classList.add('modal-open'); 
                await window.loadSharedReports(); 
            },
            closeSharedModal() { this.els.sharedModal.classList.remove('active'); document.body.classList.remove('modal-open'); },
            setLoading(loading) { this.els.submitBtn.classList.toggle('loading', loading); this.els.submitBtn.innerText = loading ? "送信中..." : (State.editingId ? "修正を保存" : "記録する"); },
            updateRoomDisplay() {
                const { tour, floor } = State.input;
                if (tour && floor) { this.els.roomName.innerText = CONSTANTS.ROOMS[`${tour}-${floor}`] || `${tour}-${floor}`; this.els.roomName.style.color = "#fff"; }
                else { this.els.roomName.innerText = floor ? "ツアーを選択" : "フロアを選択"; this.els.roomName.style.color = "#555"; }
            },
            updateSelectionStyles() {
                const s = State.input;
                const daily = Logic.calculateDailyState(this.els.date.value, State.editingId);
                if(s.floor) document.getElementById('block-floor').classList.remove('input-missing');
                if(s.tour) document.getElementById('block-tour').classList.remove('input-missing');
                if(s.vehicle) document.getElementById('block-vehicle').classList.remove('input-missing');
                if(s.profile) document.getElementById('block-profile').classList.remove('input-missing');
                document.querySelectorAll('.floor-btn').forEach(b => b.classList.toggle('selected', s.floor == b.dataset.floor));
                ['A', 'B', 'C'].forEach(t => {
                    const b = document.getElementById(`tour-btn-${t}`);
                    if (b) {
                        b.classList.toggle('selected', s.tour === t);
                        b.classList.toggle('btn-suspended-view', s.suspendedTours.includes(t));
                        b.classList.toggle('btn-caution', !s.suspendedTours.includes(t) && daily.suspended[t]);
                    }
                });
                const analysis = s.tour ? Logic.analyzeProfileStatus(this.els.date.value, s.tour) : { cautionProfiles: [] };
                document.querySelectorAll('.profile-btn').forEach(b => {
                    b.classList.toggle('selected', s.profile === b.dataset.profile);
                    b.classList.toggle('btn-caution', analysis.cautionProfiles.includes(b.dataset.profile));
                });
                ['A', 'B', 'C'].forEach(t => document.getElementById(`suspend-btn-${t}`).classList.toggle('active', s.suspendedTours.includes(t)));
            },
            updateVehicleGrid() {
                const container = this.els.vehicleContainer; container.innerHTML = '';
                const { tour, floor } = State.input;
                const currentKey = (tour && floor) ? `${tour}-${floor}` : null;
                const daily = Logic.calculateDailyState(this.els.date.value, State.editingId);
                
                const usedInOtherPlaces = new Set();
                if (currentKey) {
                    Object.entries(daily.assignments).forEach(([key, val]) => {
                        if (key !== currentKey) usedInOtherPlaces.add(parseInt(val));
                    });
                }

                for (let i = 1; i <= 9; i++) {
                    const btn = document.createElement('button'); btn.className = 'btn vehicle-btn';
                    
                    if (i === 9) {
                        btn.classList.add('btn-caution');
                        btn.innerHTML = '<span style="font-size: 0.9rem;">不明</span>';
                        if (State.input.vehicle === '不明') btn.classList.add('selected');
                        btn.onclick = () => window.handleVehicleClick('不明', false, false);
                    } else {
                        btn.innerHTML = i;
                        let caution = (i === 7 || (currentKey && daily.assignments[currentKey] && daily.assignments[currentKey] != i));
                        let isUsedElsewhere = usedInOtherPlaces.has(i);

                        if (isUsedElsewhere) {
                            btn.classList.add('btn-used');
                        } else if (caution) {
                            btn.classList.add('btn-caution');
                        }
                        
                        if (State.input.vehicle == i) btn.classList.add('selected');
                        
                        btn.addEventListener('click', () => {
                            let msg = null;
                            if (i === 7) msg = CONSTANTS.MESSAGES.vehicle7Caution;
                            if (isUsedElsewhere) msg = CONSTANTS.MESSAGES.usedVehicleCaution;
                            if (!msg && caution && daily.assignments[currentKey]) {
                                const oldVal = daily.assignments[currentKey];
                                msg = `この乗り場には既に No.${oldVal} が登録されています。No.${i} に変更しますか？`;
                            }
                            window.handleVehicleClick(i, msg);
                        });
                    }
                    container.appendChild(btn);
                }
            },
            updateEditModeUI() {
                this.els.submitBtn.innerText = State.editingId ? "修正を保存" : "記録する";
                this.els.cancelBtn.style.display = State.editingId ? "block" : "none"; 
            },
            renderHistory() {
                const div = this.els.historyContainer; 
                if (!State.logs.length) { 
                    div.innerHTML = "<p style='color:#666; padding:0;'>記録なし</p>"; 
                    return; 
                }
                const groups = {}; State.logs.forEach(l => { if (!groups[l.date]) groups[l.date] = []; groups[l.date].push(l); });
                let html = '';
                Object.keys(groups).sort((a,b)=>b.localeCompare(a)).forEach(date => {
                    const isPub = State.publishedDates.has(date);
                    const logs = groups[date];
                    const summaryHTML = generateDailySummaryHTML(logs, date);
                    html += `<details class="daily-log" ${State.openHistoryDates.has(date)?'open':''} data-date="${date}">
                        <summary class="daily-summary">
                            <div class="summary-left">
                                <span class="material-symbols-outlined">chevron_right</span>
                                <div class="summary-info"><span class="summary-date">${date}</span> <span class="summary-count">${groups[date].length}件</span></div>
                            </div>
                            <div class="summary-right">
                                <span class="publish-status-text ${isPub ? 'active' : ''}">${isPub ? '公開中' : '非公開'}</span>
                                <label class="toggle-switch-sm" onclick="event.stopPropagation();">
                                    <input type="checkbox" ${isPub ? 'checked' : ''} onchange="window.handleTogglePublish('${date}', this)">
                                    <span class="slider-sm"></span>
                                </label>
                            </div>
                        </summary>
                        <div class="history-content">
                            ${summaryHTML}
                            <div class="log-list">`;
                    groups[date].sort((a,b)=>a.count-b.count).forEach(l => {
                        const vehicleStr = l.vehicle ? l.vehicle : '--';
                        const profileName = (l.profile && l.profile !== 'UNKNOWN' && l.profile !== 'TOWER 1') ? CONSTANTS.PROFILES[l.profile] : '';
                        const memoHtml = l.memo ? `<div class="log-memo-line">${l.memo}</div>` : '';
                        
                        html += `
                        <div class="log-entry" id="log-${l.id}">
                            <div class="log-grid log-grid-my">
                                <div class="log-count">#${l.count}</div>
                                <div class="log-time">${l.time||'--:--'}</div>
                                <div class="log-content-wrapper">
                                    <div class="log-main-line">
                                        <span class="text-location">${l.tour}-${l.floor}F</span> 
                                        <span class="log-separator">/</span> 
                                        <span class="log-label-no">No.</span><span class="text-vehicle">${vehicleStr}</span>
                                        ${profileName ? `<span class="text-profile">(${profileName})</span>` : ''}
                                    </div>
                                    ${memoHtml}
                                </div>
                                <div class="log-actions desktop-only">
                                    <button class="icon-btn" onclick="window.handleEditLog('${l.id}')"><span class="material-symbols-outlined">edit</span></button>
                                    <button class="icon-btn" onclick="window.handleDeleteLog('${l.id}')"><span class="material-symbols-outlined">delete</span></button>
                                </div>
                                <div class="log-actions mobile-only">
                                    <button class="icon-btn" onclick="window.toggleMenu('${l.id}', event)"><span class="material-symbols-outlined">more_vert</span></button>
                                    <div class="action-menu" id="menu-${l.id}">
                                        <button class="action-menu-item" onclick="window.handleEditLog('${l.id}')">
                                            <span class="material-symbols-outlined">edit</span> 修正
                                        </button>
                                        <button class="action-menu-item delete-item" onclick="window.handleDeleteLog('${l.id}')">
                                            <span class="material-symbols-outlined">delete</span> 削除
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>`;
                    });
                    html += `</div></div></details>`;
                });
                div.innerHTML = html;
                div.querySelectorAll('details.daily-log').forEach(el => el.addEventListener('toggle', () => el.open ? State.openHistoryDates.add(el.dataset.date) : State.openHistoryDates.delete(el.dataset.date)));
            },
            
            renderSharedContent() {
                const content = this.els.sharedContent;
                if (!content) return;
                if (State.sharedReports.length === 0) {
                    content.innerHTML = `<div style="text-align:center; color:#666; padding:30px;">データがありません</div>`;
                    return;
                }

                if (State.currentSharedTab === 'status') {
                    let html = `
                    <div class="status-scroll-wrapper">
                        <table class="shared-status-table">
                            <thead>
                                <tr>
                                    <th rowspan="2" class="fixed-col-date">日付</th>
                                    <th colspan="2">TOUR A</th>
                                    <th colspan="2">TOUR B</th>
                                    <th colspan="2">TOUR C</th>
                                    <th rowspan="2">投稿者</th>
                                </tr>
                                <tr><th>1F</th><th>2F</th><th>1F</th><th>2F</th><th>1F</th><th>2F</th></tr>
                            </thead>
                            <tbody>`;
                    const sortedReports = [...State.sharedReports].sort((a,b) => b.date.localeCompare(a.date));
                    sortedReports.forEach(r => {
                        const s = r.summary || { A: {}, B: {}, C: {} };
                        const suspended = r.suspended || [];
                        const getVal = (t, f) => {
                            if (suspended.includes(t)) return '<span class="td-suspended" style="color:#ff5555;">×</span>';
                            return s[t] && s[t][f] ? s[t][f] : '-';
                        };
                        html += `
                        <tr>
                            <td class="fixed-col-date">${formatDate(r.date)}</td>
                            <td>${getVal('A', 1)}</td><td>${getVal('A', 2)}</td>
                            <td>${getVal('B', 1)}</td><td>${getVal('B', 2)}</td>
                            <td>${getVal('C', 1)}</td><td>${getVal('C', 2)}</td>
                            <td>
                                <div class="author-info-mini">
                                    <img src="${r.author.photoURL || ''}" class="author-icon-mini" onerror="this.style.display='none'">
                                    <span class="author-name-mini">${r.author.name}</span>
                                </div>
                            </td>
                        </tr>`;
                    });
                    html += `</tbody></table></div>`;
                    content.innerHTML = html;
                } else {
                    const allLogs = [];
                    State.sharedReports.forEach(report => {
                        if (report.logs) {
                            report.logs.forEach(log => {
                                allLogs.push({ ...log, date: report.date, author: report.author });
                            });
                        }
                    });
                    
                    allLogs.sort((a, b) => b.date.localeCompare(a.date) || (b.time || "").localeCompare(a.time || ""));
                    
                    const groupedLogs = {};
                    allLogs.forEach(log => {
                        if (!groupedLogs[log.date]) groupedLogs[log.date] = [];
                        groupedLogs[log.date].push(log);
                    });
                    
                    let html = `<div style="text-align:left;" class="shared-content-inner">`;
                    Object.keys(groupedLogs).sort((a,b)=>b.localeCompare(a)).forEach(date => {
                        html += `<div class="shared-date-header">${date.replace(/-/g, '/')}</div>`;
                        
                        const dailyLogs = groupedLogs[date].sort((a, b) => (a.count || 0) - (b.count || 0));
                        
                        dailyLogs.forEach(l => {
                             const vehicleStr = l.vehicle ? l.vehicle : '--'; 
                             const profileName = (l.profile && l.profile !== 'UNKNOWN' && l.profile !== 'TOWER 1') ? CONSTANTS.PROFILES[l.profile] : '';
                             const isMyLog = l.author?.uid === State.user?.uid;
                             const memoHtml = l.memo ? `<div class="log-memo-line">${l.memo}</div>` : '';
                             
                             const gridClass = "log-grid log-grid-shared";

                             let actionHtml = '';
                             if (isMyLog) {
                                 actionHtml = `
                                 <div class="log-actions desktop-only">
                                     <button class="icon-btn" onclick="window.handleEditLog('${l.id}')"><span class="material-symbols-outlined">edit</span></button>
                                     <button class="icon-btn" onclick="window.handleDeleteLog('${l.id}')"><span class="material-symbols-outlined">delete</span></button>
                                 </div>
                                 <div class="log-actions mobile-only">
                                     <button class="icon-btn" onclick="window.toggleMenu('${l.id}', event)"><span class="material-symbols-outlined">more_vert</span></button>
                                     <div class="action-menu" id="menu-${l.id}">
                                         <button class="action-menu-item" onclick="window.handleEditLog('${l.id}')">
                                             <span class="material-symbols-outlined">edit</span> 修正
                                         </button>
                                         <button class="action-menu-item delete-item" onclick="window.handleDeleteLog('${l.id}')">
                                             <span class="material-symbols-outlined">delete</span> 削除
                                         </button>
                                     </div>
                                 </div>`;
                             }

                             html += `
                            <div class="log-entry shared-log-entry">
                                <div class="${gridClass}">
                                    <img src="${l.author.photoURL || ''}" class="author-icon-list" onerror="this.style.display='none'">
                                    <div class="log-count">#${l.count}</div>
                                    <div class="log-time">${l.time||'--:--'}</div>
                                    <div class="log-content-wrapper">
                                        <div class="log-main-line">
                                            <span class="text-location">${l.tour}-${l.floor}F</span> 
                                            <span class="log-separator">/</span> 
                                            <span class="log-label-no">No.</span><span class="text-vehicle">${vehicleStr}</span>
                                            ${profileName ? `<span class="text-profile">(${profileName})</span>` : ''}
                                        </div>
                                        ${memoHtml}
                                    </div>
                                    ${actionHtml}
                                </div>
                            </div>`;
                        });
                    });
                    html += `</div>`;
                    content.innerHTML = html;
                }
            },
            
            showToast(msg) {
                const t = document.createElement('div'); t.className = 'toast'; t.innerText = msg;
                document.body.appendChild(t); setTimeout(()=>t.classList.add('show'),10);
                setTimeout(()=>{ t.classList.remove('show'); setTimeout(()=>t.remove(),400); },3000);
            },
            async showConfirmModal(msg) {
                return new Promise(res => {
                    const m = document.getElementById('custom-confirm-modal');
                    document.getElementById('confirm-message').innerText = msg;
                    m.classList.add('active');
                    document.getElementById('confirm-ok-btn').onclick = () => { m.classList.remove('active'); res(true); };
                    document.getElementById('confirm-cancel-btn').onclick = () => { m.classList.remove('active'); res(false); };
                });
            }
        };

        const getPaths = (userId) => {
            if (!userId) return null;
            return { logs: collection(db, 'users', userId, 'logs'), shared: collection(db, 'shared_reports') };
        };

        async function saveLog() {
            if (!State.user) return UIManager.showToast("サインインが必要です");
            const s = State.input;
            const missing = [];
            if (!s.floor) missing.push('block-floor');
            if (!s.tour) missing.push('block-tour');
            if (!s.vehicle) missing.push('block-vehicle');
            if (!s.profile) missing.push('block-profile');
            if (missing.length > 0) {
                missing.forEach(id => document.getElementById(id).classList.add('input-missing'));
                UIManager.showToast("入力が不足しています"); return;
            }
            
            const dateVal = UIManager.els.date.value;
            if (!State.editingId && State.publishedDates.has(dateVal)) {
                if (!await UIManager.showConfirmModal("この日付は公開中です。\n記録を追加して公開データを更新しますか？")) return;
            }

            UIManager.setLoading(true);
            const data = {
                date: dateVal, time: State.isTimeInputVisible ? UIManager.els.time.value : '',
                count: s.count, floor: s.floor, tour: s.tour, vehicle: s.vehicle, profile: s.profile,
                suspended: s.suspendedTours, memo: UIManager.els.memo.value, author: { uid: State.user.uid, name: State.user.displayName, photoURL: State.user.photoURL }
            };
            try {
                if (State.editingId) await updateDoc(doc(db, 'users', State.user.uid, 'logs', State.editingId), data);
                else await addDoc(collection(db, 'users', State.user.uid, 'logs'), { ...data, createdAt: serverTimestamp() });
                if (State.publishedDates.has(data.date)) await window.syncSharedReport(data.date);
                UIManager.showToast(State.editingId ? "修正しました" : "保存完了"); UIManager.resetInput();
            } catch (e) { console.error(e); UIManager.showToast("保存失敗: " + e.code); } 
            finally { UIManager.setLoading(false); }
        }

        window.handleVehicleClick = async (num, confirmMsg) => {
            if (State.input.vehicle == num) { State.input.vehicle = null; UIManager.updateAll(); return; }
            if (confirmMsg && !await UIManager.showConfirmModal(confirmMsg)) return;
            State.input.vehicle = num;
            UIManager.updateAll();
        };

        window.handleEditLog = async (id) => {
            const log = State.logs.find(l => l.id === id);
            const sharedModal = document.getElementById('shared-db-modal');
            const isSharedOpen = sharedModal.classList.contains('active');

            if (log && await UIManager.showConfirmModal("修正モードを開きますか？")) {
                State.lastScrollPos = window.scrollY; 

                if (isSharedOpen) {
                    const sharedList = document.getElementById('shared-content-area');
                    State.lastSharedScrollPos = sharedList.scrollTop;
                    State.isEditingFromShared = true;
                    UIManager.closeSharedModal();
                } else {
                    State.isEditingFromShared = false;
                    State.lastSharedScrollPos = null;
                }

                State.editingId = id; State.input = { ...log, suspendedTours: log.suspended || [] };
                UIManager.els.date.value = log.date;
                if (log.time) { UIManager.els.time.value = log.time; UIManager.activateTimeInput(); }
                UIManager.updateAll(); 
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        };

        window.handleDeleteLog = async (id) => {
            if (await UIManager.showConfirmModal("削除しますか？")) {
                const logToDelete = State.logs.find(l => l.id === id);
                if (!logToDelete) return;
                const dateToDelete = logToDelete.date;
                await deleteDoc(doc(db, 'users', State.user.uid, 'logs', id));
                
                if (State.publishedDates.has(dateToDelete)) {
                    await window.syncSharedReport(dateToDelete);
                }
                
                State.sharedReports = State.sharedReports.map(report => {
                    if (report.date === dateToDelete && report.author.uid === State.user.uid) {
                        const newLogs = report.logs.filter(l => l.id !== id);
                        if (newLogs.length === 0) return null;
                        const newSummary = { A: {}, B: {}, C: {} };
                        newLogs.forEach(l => { if(l.tour && l.floor && l.vehicle) newSummary[l.tour][l.floor] = l.vehicle; });
                        return { ...report, logs: newLogs, summary: newSummary };
                    }
                    return report;
                }).filter(Boolean);

                UIManager.showToast("削除しました");
                if (document.getElementById('shared-db-modal').classList.contains('active')) {
                    UIManager.renderSharedContent();
                }
            }
        };

        window.handleTogglePublish = async (dateStr, checkbox) => {
            const isChecked = checkbox.checked;
            if (isChecked) {
                if (!await UIManager.showConfirmModal(CONSTANTS.MESSAGES.confirmPublish)) {
                    checkbox.checked = false; 
                    return;
                }
                
                try {
                    await window.syncSharedReport(dateStr);
                    State.publishedDates.add(dateStr);
                    UIManager.showToast("公開しました");
                } catch (error) {
                    console.error("Publish Error:", error);
                    checkbox.checked = false;
                    State.publishedDates.delete(dateStr);
                    UIManager.showToast("公開失敗: " + (error.code || error.message));
                }
            } else {
                if (!await UIManager.showConfirmModal(CONSTANTS.MESSAGES.confirmUnpublish)) {
                     checkbox.checked = true;
                     return;
                }

                try {
                    await deleteDoc(doc(db, 'shared_reports', dateStr + "_" + State.user.uid));
                    State.publishedDates.delete(dateStr);
                    UIManager.showToast("非公開にしました");
                } catch(e) { 
                    console.error("Unpublish Error:", e);
                    checkbox.checked = true; 
                    UIManager.showToast("エラー: " + (e.code || e.message)); 
                }
            }
            UIManager.renderHistory();
        };

        window.syncSharedReport = async (dateStr) => {
            const dailyData = Logic.calculateDailyState(dateStr);
            const logs = State.logs.filter(l => l.date === dateStr);
            
            if (logs.length === 0) {
                try {
                    await deleteDoc(doc(db, 'shared_reports', dateStr + "_" + State.user.uid));
                    State.publishedDates.delete(dateStr);
                } catch(e) {
                    console.log("Delete skipped or failed", e);
                }
                return;
            }

            const summary = { A: {}, B: {}, C: {} };
            logs.forEach(l => { if(l.tour && l.floor && l.vehicle) summary[l.tour][l.floor] = l.vehicle; });
            
            const reportData = {
                date: dateStr, summary: summary,
                author: { uid: State.user.uid, name: State.user.displayName || "NoName", photoURL: State.user.photoURL },
                updatedAt: serverTimestamp(),
                suspended: Array.from(Object.keys(dailyData.suspended).filter(k=>dailyData.suspended[k])),
                logs: logs.map(l => ({ id: l.id, time: l.time, count: l.count, tour: l.tour, floor: l.floor, vehicle: l.vehicle, profile: l.profile }))
            };
            
            await setDoc(doc(db, 'shared_reports', dateStr + "_" + State.user.uid), reportData); 
        };

        window.loadSharedReports = async () => {
             UIManager.els.sharedContent.innerHTML = '<div style="padding:20px;text-align:center;">読み込み中...</div>';
             try {
                 const q = query(collection(db, 'shared_reports'), orderBy('date', 'desc'), limit(50));
                 const snapshot = await getDocs(q);
                 State.sharedReports = snapshot.docs.map(d => d.data());
                 UIManager.renderSharedContent();
             } catch(e) {
                 console.error(e);
                 UIManager.els.sharedContent.innerHTML = '<div style="padding:20px;text-align:center;">読み込みエラー<br><small>' + e.message + '</small></div>';
             }
        };

        const handleTourSelect = (t) => {
            State.input.tour = State.input.tour === t ? null : t;
            if (State.input.tour) {
                const analysis = Logic.analyzeProfileStatus(UIManager.els.date.value, State.input.tour);
                if (!State.input.profile || State.input.profile === 'UNKNOWN') State.input.profile = analysis.defaultProfile;
            }
            UIManager.updateAll();
        };

        const handleProfileSelect = async (p) => {
            if (State.input.tour) {
                const analysis = Logic.analyzeProfileStatus(UIManager.els.date.value, State.input.tour);
                if (analysis.cautionProfiles.includes(p)) {
                    if (!await UIManager.showConfirmModal(`推奨設定とは異なります。\n「${CONSTANTS.PROFILES[p]}」を選択しますか？`)) return;
                }
            }
            State.input.profile = p;
            UIManager.updateAll();
        };

        window.login = async () => {
            try { await signInWithPopup(auth, new TwitterAuthProvider()); }
            catch (error) { console.error("Login failed", error); UIManager.showToast("ログインに失敗しました"); }
        };

        window.logout = async () => {
            if (await UIManager.showConfirmModal(CONSTANTS.MESSAGES.confirmLogout)) {
                try { await signOut(auth); } catch (error) { console.error("Logout failed", error); }
            }
        };

        window.onload = async () => {
            UIManager.init();
            let unsubscribeLogs = null;
            let unsubscribeShared = null;
            
            const configRef = doc(db, 'config', 'schedules');
            onSnapshot(configRef, (doc) => {
                if (doc.exists()) {
                    State.specialSchedules = doc.data().special_programs || [];
                    if (State.input.tour) handleTourSelect(State.input.tour);
                }
            }, (error) => console.log("Config fetch error (ignored):", error));

            onAuthStateChanged(auth, user => {
                if (unsubscribeLogs) { unsubscribeLogs(); unsubscribeLogs = null; }
                if (unsubscribeShared) { unsubscribeShared(); unsubscribeShared = null; }
                State.user = user;
                if (user) {
                    document.getElementById('user-info').style.display = 'flex';
                    document.getElementById('login-container').style.display = 'none';
                    document.getElementById('user-name').innerText = user.displayName || 'Guest';
                    document.getElementById('user-icon').src = user.photoURL || '';
                    const paths = getPaths(user.uid);
                    if (paths) {
                        unsubscribeLogs = onSnapshot(paths.logs, (snap) => {
                            State.logs = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                            if (!State.editingId) {
                                const nextState = Logic.calculateNextState(UIManager.els.date.value);
                                State.input.count = nextState.count;
                                State.input.suspendedTours = nextState.suspendedTours;
                            }
                            UIManager.updateAll();
                        }, (error) => console.error(error));
                        const q = query(paths.shared, where("author.uid", "==", user.uid));
                        unsubscribeShared = onSnapshot(q, (snap) => {
                            State.publishedDates = new Set(snap.docs.map(d => d.data().date));
                            UIManager.renderHistory();
                        }, (error) => console.error(error));
                    }
                } else {
                    document.getElementById('user-info').style.display = 'none';
                    document.getElementById('login-container').style.display = 'block';
                    State.logs = []; State.publishedDates = new Set();
                    UIManager.updateAll();
                }
            });
            document.getElementById('login-btn').addEventListener('click', window.login);
            document.getElementById('logout-btn').addEventListener('click', window.logout);
            document.getElementById('visit-date').onchange = () => UIManager.handleDateChange(true);
            document.getElementById('btn-count-plus').onclick = () => { State.input.count++; UIManager.updateAll(); };
            document.getElementById('btn-count-minus').onclick = () => { State.input.count = Math.max(1, State.input.count-1); UIManager.updateAll(); };
            document.getElementById('time-widget').onclick = () => UIManager.activateTimeInput();
            
            document.getElementById('visit-time').onclick = (e) => {
                e.stopPropagation();
                if('showPicker' in HTMLInputElement.prototype) {
                    e.target.showPicker();
                }
            };
            
            document.querySelector('.time-clear-btn').onclick = (e) => { e.stopPropagation(); UIManager.deactivateTimeInput(); };
            document.getElementById('floor-1').onclick = () => { State.input.floor = State.input.floor === 1 ? null : 1; UIManager.updateAll(); };
            document.getElementById('floor-2').onclick = () => { State.input.floor = State.input.floor === 2 ? null : 2; UIManager.updateAll(); };
            ['A', 'B', 'C'].forEach(t => {
                document.getElementById(`tour-btn-${t}`).onclick = () => handleTourSelect(t);
                document.getElementById(`suspend-btn-${t}`).onclick = async () => {
                    const idx = State.input.suspendedTours.indexOf(t);
                    const isSuspended = idx > -1;
                    const confirmMsg = isSuspended 
                        ? `TOUR ${t} を「運営中」に変更しますか？` 
                        : `TOUR ${t} を「運営休止」に設定しますか？`;
                    
                    if (await UIManager.showConfirmModal(confirmMsg)) {
                        if (isSuspended) State.input.suspendedTours.splice(idx, 1); else State.input.suspendedTours.push(t);
                        UIManager.updateAll();
                    }
                };
            });
            ['std', 'l13', 'shadow', 'unknown'].forEach((id, idx) => {
                const pKeys = ['TOWER 1', 'TOWER 2', 'TOWER 3', 'UNKNOWN'];
                document.getElementById(`prof-${id}`).onclick = () => handleProfileSelect(pKeys[idx]);
            });
            document.getElementById('submit-btn').onclick = saveLog;
            document.getElementById('cancel-btn').onclick = () => UIManager.resetInput();
            document.querySelector('.shared-trigger').onclick = () => UIManager.openSharedModal();
            document.querySelector('.modal-close-btn').onclick = () => UIManager.closeSharedModal();
            document.querySelector('.refresh-btn').onclick = () => window.loadSharedReports();
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.onclick = (e) => {
                    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                    e.target.classList.add('active'); State.currentSharedTab = e.target.dataset.tab;
                    UIManager.renderSharedContent();
                };
            });
            UIManager.updateAll();
        };
    </script>
</body>
</html>